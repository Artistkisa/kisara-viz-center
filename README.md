# M站 N区 智能分析系统 v3

基于 Node.js 的 M系镜像站 N区（forum/18）内容智能分析工具，采用 jieba 分词、TF-IDF 加权、主题聚类、情感分析和 VDI 暴力密度指数等多种算法，生成全面的数据分析报告和可视化图表。

---

## 📋 目录

1. [整体流程图](#整体流程图)
2. [核心功能](#核心功能)
3. [VDI 暴力密度指数算法](#vdi-暴力密度指数算法)
4. [分层词库与机制](#分层词库与机制)
5. [可视化系统](#可视化系统)
6. [使用方法](#使用方法)
7. [输出文件说明](#输出文件说明)
8. [安全特性](#安全特性)
9. [技术栈](#技术栈)
10. [免责声明](#免责声明)

---

## 整体流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                      M站 N区 智能分析系统 v3                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 数据获取层                                                    │
│  ├─ 多页帖子列表抓取（forum/18，+0, +30, +60...）                   │
│  ├─ 逐个获取帖子详情（/thread/{id}）                              │
│  └─ HTML 解析提取回复内容                                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 文本预处理层                                                  │
│  ├─ jieba 分词（精确模式）                                        │
│  ├─ 停用词过滤（300+ 常见词汇）                                    │
│  ├─ 角色名识别（白名单+黑名单+词性分析）                            │
│  └─ 情感词标记（正面/负面词典）                                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 核心分析层                                                    │
│  ├─ TF-IDF 词频加权                                              │
│  ├─ 共现网络构建（窗口大小 5）                                     │
│  ├─ 主题聚类（基于共现图的连通分量）                                │
│  ├─ 情感分析（三分类统计）                                         │
│  └─ VDI 暴力密度指数计算（核心算法）                                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 可视化层                                                      │
│  ├─ 分层放置词云图（大/中/小 三层策略）                            │
│  ├─ VDI 分布柱状图                                                │
│  ├─ VDI 仪表盘                                                    │
│  ├─ VDI 回复趋势图（2011 点）                                     │
│  └─ VDI 主题趋势图（210 点，前 15 标记）                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 输出层                                                        │
│  ├─ 生成文本分析报告                                              │
│  ├─ 生成 VDI 排名文件                                             │
│  ├─ 打包加密 ZIP（密码保护）                                       │
│  └─ 安全清理（覆盖删除明文文件）                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心功能

### 1. 智能文本分析

#### jieba 分词
- 使用 `nodejieba` 库的精确模式
- 支持自定义词典扩展
- 识别词性：名词(n)、动词(v)、形容词(a)、人名(nr)等

#### TF-IDF 加权
```javascript
IDF = log(总文档数 / (包含该词的文档数 + 1)) + 1
TF-IDF = 词频 × IDF
```

#### 角色名识别机制
1. **白名单**：预定义真实角色名（如"颜心怜"、"聪美"）
2. **黑名单**：过滤常见误识别词（如"高跟鞋"、"看起来"）
3. **词性过滤**：只保留 nr/nrt 词性
4. **长度过滤**：3-4 字词汇优先

### 2. 主题聚类分析

#### 共现网络构建
- 窗口大小：5 个词
- 边权重：共现次数
- 保留边：共现次数 ≥ 3

#### 主题提取算法
1. 构建无向加权共现图
2. 提取连通分量作为主题
3. 每个主题选择度最高的词作为种子
4. 限制主题数量：5 个

### 3. 情感分析

#### 情感词典
- **正面词**：喜欢、享受、快乐、满足、舒服、愉悦...
- **负面词**：痛苦、难受、折磨、煎熬、挣扎、恐惧...

#### 分类规则
```
正面词数 > 负面词数 → 正面
负面词数 > 正面词数 → 负面
否则 → 中性
```

---

## VDI 暴力密度指数算法

### 核心公式

```
VDI = (Σ(violence_weight_i) / total_words) × 1000 × context_boost × time_compression
```

### 暴力词权重计算

```javascript
violence_weight_i = base_weight × negation_factor × character_bonus × organ_boost

其中：
- base_weight: 词库定义的基础权重 (0.5-2.0)
- negation_factor: 否定检测因子 (0.3 / 1.0 / 1.2)
- character_bonus: 角色名加成 (+0.2)
- organ_boost: 器官关联加成 (1.0-1.5)
```

### 否定检测机制

```javascript
// 单重否定：权重 × 0.3
"不许反抗" → 反抗权重 × 0.3

// 双重否定：正常权重
"不得不服从" → 服从正常权重

// 反问强调：权重 × 1.2
"你也配拒绝？" → 拒绝权重 × 1.2
```

### 语境增强规则

| 增强类型 | 触发词 | 倍率 | 说明 |
|----------|--------|------|------|
| 服从强化 | 完全、彻底、绝对、只能、必须 | ×1.3 | 强调无条件服从 |
| 痛苦强化 | 痛苦、惨叫、颤抖、流泪、求饶 | ×1.4 | 受害方反应剧烈 |
| 公开羞辱 | 当众、公开、所有人面前、示众 | ×1.5 | 公开场合更严重 |
| 私密支配 | 私下、单独、秘密、隐秘 | ×1.2 | 私密空间加成 |
| 关系背叛 | 母亲、姐姐、女友、闺蜜 | ×1.4 | 亲密关系间创伤 |
| 身份落差 | 女王、女神、奴、贱、下贱 | ×1.5 | 地位悬殊加成 |
| 持续控制 | 永远、一直、终身、永久 | ×1.3 | 长期支配关系 |
| 仪式化 | 仪式、典礼、宣誓、契约 | ×1.4 | 仪式化支配 |
| 群体支配 | 大家、所有人、集体、轮流 | ×1.5 | 多人共同支配 |
| 物化 | 物品、工具、玩具、宠物 | ×1.3 | 将人视为物品 |

### 时间压缩规则

| 时间范围 | 倍率 | 说明 |
|----------|------|------|
| 瞬间/立刻/马上/顿时 | ×1.5 | 即时暴力最剧烈 |
| 几秒/数秒/片刻 | ×1.5 | 短时间高烈度 |
| 几分钟/不久/很快 | ×1.3 | 短时间集中 |
| 几小时/半天 | ×1.1 | 较长时间 |
| 持续/一直/永远 | ×1.0 | 常态支配 |

### 器官关联检测

```javascript
// 器官暗示词
ORGAN_TRIGGERS = ['那里', '下面', '私处', '敏感', '脆弱', '要害']

// 特定组合直接加权
'折磨+敏感' → 1.5
'玩弄+脆弱' → 1.5
'控制+要害' → 1.4
'羞辱+那里' → 1.3

// 窗口检测：前后3个词
```

### VDI 分级标准

| VDI 范围 | 等级 | 颜色 | 描述 | 特征 |
|----------|------|------|------|------|
| 0-10 | 🟢 安全 | #4caf50 | 日常/温情叙事 | 无暴力词或极少 |
| 10-30 | 🟡 轻度 | #ffeb3b | 悬疑/冲突暗示 | 轻度控制词汇 |
| 30-60 | 🟠 中度 | #ff9800 | 对抗/创伤回忆 | 明确惩罚描述 |
| 60-100 | 🔴 高度 | #f44336 | 直接暴力描写 | 详细暴力场景 |
| >100 | ⚫ 极端 | #212121 | 灾难/战争/内爆 | 极端暴力内容 |

---

## 分层词库与机制

### 完整分层词库

#### 1. 基础控制层 (0.5-0.7)
```
命令(0.6)  要求(0.5)  吩咐(0.5)  指示(0.6)  责令(0.7)
呵斥(0.7)  训斥(0.7)  责罚(0.6)  管束(0.5)  约束(0.5)
```

#### 2. 身体惩罚层 (0.7-0.9)
```
惩罚(0.8)  责打(0.8)  鞭打(0.9)  抽打(0.9)  拍打(0.7)
踢打(0.8)  踩踏(0.8)  捆绑(0.8)  束缚(0.7)  禁锢(0.8)
```

#### 3. 感官控制层 (0.8-1.0)
```
蒙眼(0.8)  堵嘴(0.8)  固定(0.8)  悬吊(0.9)  跪伏(0.8)
趴伏(0.8)
```

#### 4. 精神支配层 (1.0-1.3)
```
控制(1.1)  支配(1.2)  掌控(1.2)  操纵(1.2)  驾驭(1.1)
洗脑(1.3)  臣服(1.2)  服从(1.0)  顺从(1.0)  皈依(1.2)
认命(1.1)
```

#### 5. 羞辱践踏层 (1.2-1.5)
```
羞辱(1.3)  践踏(1.4)  蹂躏(1.4)  摧残(1.4)  玩弄(1.3)
侮辱(1.2)  贬低(1.2)  蔑视(1.2)  嘲讽(1.2)  讥笑(1.2)
唾弃(1.3)
```

#### 6. 上贡奉献层 (1.0-1.4)
```
上贡(1.1)  奉献(1.1)  贡献(1.0)  供奉(1.0)  进献(1.0)
献身(1.2)  献祭(1.3)  牺牲(1.2)  付出(1.0)  回报(1.0)
感恩(1.0)  崇拜(1.1)  迷恋(1.1)  痴迷(1.2)  沉醉(1.1)
只属于(1.3)  完全属于(1.4)  身心都属于(1.4)  专属(1.2)
私有(1.2)  所有物(1.3)
```

#### 7. 极端暴力层 (1.5-2.0)
```
折磨(1.6)  虐杀(1.8)  毁灭(1.7)  彻底摧毁(1.8)  完全支配(1.7)
彻底臣服(1.6)  完全占有(1.7)  绝对控制(1.7)
```

#### 8. 语言嘲讽层 (0.8-1.5)
```
贱(1.0)  贱奴(1.2)  贱狗(1.2)  贱货(1.2)  废物(1.1)
垃圾(1.0)  虫子(0.9)  蝼蚁(0.9)  畜生(1.1)  猪(1.0)  狗(0.9)
没用(0.9)  无能(0.9)  可怜(0.8)  可悲(0.9)  可笑(0.8)
下贱(1.2)  低贱(1.2)  卑贱(1.2)  卑微(1.0)  下等(1.0)
不配(1.2)  也配(1.3)  只配(1.3)  跪下(1.2)  爬过来(1.3)
舔干净(1.3)  叫主人(1.2)  承认你是(1.2)
```

### 词库选择机制

1. **最长匹配优先**："彻底摧毁" > "摧毁"
2. **组合词加权**："公开"+"羞辱" 触发双重语境增强
3. **频率衰减**：同一词多次出现，后续权重递减 10%
4. **上下文窗口**：±3 词范围内检测关联词

---

## 可视化系统

### 系统负载监控

实时监控系统性能指标：
- **CPU 使用率**：实时百分比和负载趋势
- **内存使用**：使用量和百分比
- **磁盘使用**：存储空间监控
- **系统负载**：1分钟/5分钟/15分钟平均负载

**访问地址**：https://monitor.kisara.info/system-load-visualization.html

**技术特点**：
- 科幻风格界面（霓虹渐变、扫描线效果）
- Chart.js 实时图表
- 每15分钟自动采集（一天56个数据点）
- 自动避开 cron 任务高峰期

### 1. 分层放置词云图

#### 画布规格
- 尺寸：2400×1800 像素
- 背景：径向渐变（#1a1a2e → #0f0f1a）
- 字体：Microsoft YaHei Bold

#### 分层策略
```
第 1 层（大词）：size > 70px
├─ 数量：约 15 个（前 10 词 + 前 5 角色）
├─ 间距：5px
├─ 尝试次数：800
└─ 放置策略：从中心开始，优先中心位置

第 2 层（中词）：25px ≤ size ≤ 70px
├─ 数量：约 40 个
├─ 间距：3px
├─ 尝试次数：1000
└─ 放置策略：填充大词周围空隙

第 3 层（小词）：size < 25px
├─ 数量：约 195 个
├─ 间距：1px
├─ 尝试次数：1500
└─ 放置策略：密集填充剩余空间
```

#### 放置算法
```javascript
function placeWords(words, spacing, maxAttempts) {
  for (each word) {
    attempts = 0
    angle = random(0, 2π)
    radius = 0
    
    while (not placed && attempts < maxAttempts) {
      x = centerX + cos(angle) * radius
      y = centerY + sin(angle) * radius
      
      if (no collision with placed words) {
        place word at (x, y)
        mark as placed
      }
      
      angle += 0.2 + random(0, 0.1)
      radius += 1.5 + random(0, 1)
      attempts++
    }
  }
}
```

### 2. VDI 主题趋势图

#### 规格
- 尺寸：1200×400 像素
- X 轴：0-210（主题帖序号）
- Y 轴：0-120（VDI 值）

#### 前 15 名标记
```
TOP 1:   红色 #ff0000,   半径 8px,  字体 12px bold, 显示完整标题
TOP 2-3: 红色 #ff3333,   半径 7px,  字体 11px bold, 显示前 15 字
TOP 4-8: 橙色 #ff9800,   半径 6px,  字体 10px,      显示前 10 字
TOP 9-15:黄色 #ffeb3b,   半径 5px,  不显示字
```

#### 分割线
- 30（轻度→中度）：虚线 #666666
- 60（中度→高度）：虚线 #666666
- 90（高度→极端）：虚线 #666666

### 3. 其他可视化

| 图表 | 尺寸 | 内容 |
|------|------|------|
| VDI 分布柱状图 | 800×600 | 5 级分布，彩色柱状 |
| VDI 仪表盘 | 600×400 | 半圆仪表盘，指针指示 |
| VDI 回复趋势图 | 1600×400 | 2011 个回复的 VDI 折线 |

---

## 使用方法

### 安装依赖
```bash
npm install nodejieba canvas
```

### 配置
编辑脚本开头的常量：
```javascript
const FORUM_URL = 'https://maso.top/forum/18'  // 目标论坛
const ZIP_PASSWORD = 'Tep691'                   // ZIP 密码
```

### 运行分析
```bash
node scripts/maso-nsfw-analysis-v3.js
```

### 发送报告
```bash
node scripts/send-report.js
```

---

## 输出文件说明

### 主报告
`nsfw-report-v3-{timestamp}.txt`
- 数据概览
- 情感分析
- VDI 分析（主题帖 TOP 5 + 回复 TOP 5）
- 角色名列表
- 主题聚类
- 热词排行
- 共现分析
- 活跃用户
- 热门帖子

### 排名文件
`vdi-rank-threads-{timestamp}.txt`
- 主题帖 VDI 排名 TOP 15
- 包含：VDI 值、作者、标题、回复数

### 可视化文件
| 文件名 | 说明 |
|--------|------|
| wordcloud-*.png | 分层放置词云图 |
| vdi-distribution-*.png | VDI 分布柱状图 |
| vdi-gauge-*.png | VDI 仪表盘 |
| vdi-trend-replies-*.png | 回复级别趋势 |
| vdi-trend-threads-*.png | 主题级别趋势 |

### 加密 ZIP
- 文件名：`nsfw-report-v3-{timestamp}.zip`
- 密码：`Tep691`
- 包含：所有报告和可视化文件

---

## 安全特性

### 1. 启动清理
```javascript
function cleanupResidualData() {
  // 删除输出目录中所有非 ZIP 文件
  // 清理数据文件中的原始内容字段
}
```

### 2. 内存安全
```javascript
// 用随机数据覆盖敏感内容
for (each content) {
  content = 'x'.repeat(content.length)
}
```

### 3. 文件安全
```javascript
// 先覆盖文件内容，再删除
const buffer = Buffer.alloc(fileSize, 0)
fs.writeSync(fd, buffer)
fs.closeSync(fd)
fs.unlinkSync(filePath)
```

### 4. 数据隔离
- 仅保存统计数据（词频、VDI 值等）
- 不保存原始 HTML 或完整文本
- ZIP 加密保护

---

## 技术栈

| 组件 | 用途 |
|------|------|
| Node.js v22 | 运行时环境 |
| nodejieba | 中文分词 |
| canvas | 可视化图表生成 |
| https | 网络请求 |
| fs | 文件操作 |

---

## 免责声明

本工具仅供个人研究和学习使用，请遵守：
1. 相关法律法规
2. 网站使用条款（robots.txt）
3. 版权规定

分析结果仅供参考，不代表任何官方立场。使用者需自行承担使用本工具产生的一切后果。

---

## 更新日志

### v3.1 (2026-02-19)
- ✨ 新增系统负载监控可视化
  - 实时监控 CPU、内存、磁盘、系统负载
  - 科幻风格可视化界面
  - 每15分钟自动采集，每天56个数据点
  - 访问：https://monitor.kisara.info/system-load-visualization.html
- ✨ 新增多邮箱 AI 自动回复系统
  - artist@kisara.art（站长）- 亲切专业风格
  - staff@kisara.art（客服）- 正式商务风格
  - 26条客服原则，智能转接机制

### v3.0 (2026-02-16)
- ✨ 新增 VDI 暴力密度指数算法
- ✨ 新增 4 种 VDI 可视化图表
- ✨ 新增分层放置词云图算法（60%+ 放置率）
- ✨ 新增主题帖 VDI 排名文件
- 🔒 新增安全清理机制
- 📊 优化报告格式，添加双维度 VDI TOP 5

---

**作者**：OpenClaw 智能分析系统  
**版本**：v3.0  
**更新日期**：2026-02-16  
**License**：MIT
