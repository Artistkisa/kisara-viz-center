<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›å—å¤©ç›‘æµ‹ - å¹¿å·</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.3rem;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #8892b0;
            text-decoration: none;
        }
        .back-link:hover { color: #fff; }
        
        /* çŠ¶æ€å¡ç‰‡ */
        .status-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            border: 3px solid;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        .status-card.normal { border-color: #00c853; background: rgba(0,200,83,0.1); }
        .status-card.mild { border-color: #feca57; background: rgba(254,202,87,0.1); }
        .status-card.moderate { border-color: #ff9800; background: rgba(255,152,0,0.1); }
        .status-card.severe { border-color: #ff1744; background: rgba(255,23,68,0.1); }
        
        .status-card.pulse::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid;
            animation: pulse-ring 2s ease-out infinite;
            transform: translate(-50%, -50%);
        }
        
        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        .status-icon { font-size: 5rem; margin-bottom: 15px; animation: bounce 2s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .status-text { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .status-card.normal .status-text { color: #00c853; }
        .status-card.mild .status-text { color: #feca57; }
        .status-card.moderate .status-text { color: #ff9800; }
        .status-card.severe .status-text { color: #ff1744; }
        
        /* å®æ—¶æ•°æ®å¡ç‰‡ */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }
        .metric:hover { transform: translateY(-5px); }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .metric-label { color: #8892b0; margin-top: 8px; font-size: 0.95rem; }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .chart-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        .confidence-bar {
            height: 12px;
            background: linear-gradient(to right, #666 0%, #666 25%, #87ceeb 25%, #87ceeb 50%, #4169e1 50%, #4169e1 75%, #000080 75%, #000080 100%);
            border-radius: 6px;
            margin-bottom: 15px;
            position: relative;
        }
        .confidence-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #8892b0;
            margin-bottom: 20px;
        }
        
        /* å­å›¾ç½‘æ ¼ */
        .sub-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .sub-chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sub-chart {
            height: 200px;
        }
        
        /* å›¾ä¾‹ */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #8892b0;
        }
        .legend-color {
            width: 20px;
            height: 10px;
            border-radius: 2px;
        }
        
        /* åˆ¤æ–­æ ‡å‡† */
        .info-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .info-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s, border-color 0.3s;
        }
        .info-card:hover {
            transform: translateY(-3px);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .info-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        .info-card p {
            color: #8892b0;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .info-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }
        .info-badge.mild { background: rgba(254,202,87,0.2); color: #feca57; }
        .info-badge.moderate { background: rgba(255,152,0,0.2); color: #ff9800; }
        .info-badge.severe { background: rgba(255,23,68,0.2); color: #ff1744; }
        .info-badge.core { background: rgba(102,126,234,0.2); color: #667eea; }
        .info-badge.aux { background: rgba(0,200,83,0.2); color: #00c853; }
        
        .update-time {
            text-align: center;
            color: #8892b0;
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .sub-charts { grid-template-columns: 1fr; }
            .metrics { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../" class="back-link">â† è¿”å›å¯è§†åŒ–ä¸­å¿ƒ</a>
        <h1>ğŸŒ«ï¸ å›å—å¤©ç›‘æµ‹</h1>
        
        <div class="status-card normal" id="statusCard">
            <div class="status-icon">â˜€ï¸</div>
            <div class="status-text">æ­£å¸¸</div>
            <div style="color: #8892b0; font-size: 1.1rem;">
                âœ… ç©ºæ°”æ¹¿åº¦æ­£å¸¸
            </div>
        </div>
        
        <div class="metrics" id="metrics">
            <div class="metric">
                <div class="metric-value" id="humidityValue">--%</div>
                <div class="metric-label">ğŸ’§ ç›¸å¯¹æ¹¿åº¦</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="dewValue">--Â°C</div>
                <div class="metric-label">ğŸŒ¡ï¸ éœ²ç‚¹æ¸©åº¦</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="tempValue">--Â°C</div>
                <div class="metric-label">ğŸŒ¡ï¸ ç©ºæ°”æ¸©åº¦</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="confidenceValue">-/3</div>
                <div class="metric-label">ğŸ¯ ç½®ä¿¡åº¦</div>
            </div>
        </div>
        
        <div class="chart-section">
            <h2>ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h2>
            
            <!-- ç½®ä¿¡åº¦è‰²å¸¦ -->
            <div style="margin-bottom: 10px;">
                <div style="color: #8892b0; font-size: 12px; margin-bottom: 5px;">ç½®ä¿¡åº¦è‰²å¸¦</div>
                <div class="confidence-bar"></div>
                <div class="confidence-labels">
                    <span>0åˆ† (ç°)</span>
                    <span>1åˆ† (æµ…è“)</span>
                    <span>2åˆ† (ä¸­è“)</span>
                    <span>3åˆ† (æ·±è“)</span>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #667eea;"></div>
                    <span>æ¹¿åº¦</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #feca57;"></div>
                    <span>æ¸©åº¦</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00c853;"></div>
                    <span>éœ²ç‚¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff1744;"></div>
                    <span>85%åŸºçº¿</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(147,112,219,0.5);"></div>
                    <span>æ­£å¼å›å—å¤©</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(147,112,219,0.2);"></div>
                    <span>ç–‘ä¼¼å›å—å¤©</span>
                </div>
            </div>
        </div>
        
        <!-- å­å›¾åŒºåŸŸ -->
        <div class="sub-charts">
            <div class="sub-chart-container">
                <h4 style="color: #fff; margin-bottom: 10px;">ğŸŒ¬ï¸ é£å‘é£é€Ÿ</h4>
                <div id="windChart" class="sub-chart"></div>
            </div>
            <div class="sub-chart-container">
                <h4 style="color: #fff; margin-bottom: 10px;">ğŸ“Š æ°”å‹</h4>
                <div id="pressureChart" class="sub-chart"></div>
            </div>
        </div>
        
        <div class="info-section">
            <h2>â„¹ï¸ å›å—å¤©åˆ¤æ–­æ ‡å‡†ï¼ˆv3å…­æ­¥ç®—æ³•ï¼‰</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h4><span class="info-badge core">æ ¸å¿ƒ</span>æ¹¿åº¦æ¡ä»¶</h4>
                    <p>ç›¸å¯¹æ¹¿åº¦ â‰¥ 85%ï¼Œæ˜¯å›å—å¤©å½¢æˆçš„åŸºç¡€æ¡ä»¶ã€‚æ¹¿åº¦è¶Šé«˜ï¼Œå›å—å¤©è¶Šæ˜æ˜¾ã€‚</p>
                </div>
                <div class="info-card">
                    <h4><span class="info-badge core">æ ¸å¿ƒ</span>éœ²ç‚¹æ¸©å·®</h4>
                    <p>æ¸©åº¦ - éœ²ç‚¹ â‰¤ 2.5Â°Cï¼Œè¡¨ç¤ºç©ºæ°”æ¥è¿‘é¥±å’Œï¼Œæ°´æ±½å®¹æ˜“å‡ç»“ã€‚</p>
                </div>
                <div class="info-card">
                    <h4><span class="info-badge core">æ ¸å¿ƒ</span>æ¹¿åº¦è¶‹åŠ¿</h4>
                    <p>è¿‡å»3å°æ—¶æ¹¿åº¦æŒå¹³æˆ–ä¸Šå‡ï¼Œè¡¨æ˜æš–æ¹¿æ°”æµæ­£åœ¨åŠ å¼ºã€‚</p>
                </div>
                <div class="info-card">
                    <h4><span class="info-badge aux">è¾…åŠ©</span>é£å‘æ¡ä»¶</h4>
                    <p>é£å‘åœ¨ 135Â°-225Â°ï¼ˆä¸œå—åˆ°è¥¿å—ï¼‰ï¼Œå¸¦æ¥æµ·æ´‹æš–æ¹¿æ°”æµã€‚</p>
                </div>
                <div class="info-card">
                    <h4><span class="info-badge aux">è¾…åŠ©</span>æ°”å‹å˜åŒ–</h4>
                    <p>è¿‡å»6å°æ—¶æ°”å‹ä¸‹é™ â‰¥ 2hPaï¼Œè¡¨æ˜æš–æ¹¿æ°”æµæ­£åœ¨æ¨è¿›ã€‚</p>
                </div>
                <div class="info-card">
                    <h4><span class="info-badge mild">è½»åº¦</span>ç­‰çº§æ ‡å‡†</h4>
                    <p>æ¹¿åº¦ 85-90% æˆ–æ¸©å·® 2-2.5Â°C</p>
                </div>
                <div class="info-card">
                    <h4><span class="info-badge moderate">ä¸­åº¦</span>ç­‰çº§æ ‡å‡†</h4>
                    <p>æ¹¿åº¦ 90-95% æˆ–æ¸©å·® 1-2Â°C</p>
                </div>
                <div class="info-card">
                    <h4><span class="info-badge severe">é‡åº¦</span>ç­‰çº§æ ‡å‡†</h4>
                    <p>æ¹¿åº¦ > 95% æˆ–æ¸©å·® < 1Â°C</p>
                </div>
            </div>
        </div>
        
        <p class="update-time" id="updateTime">åŠ è½½ä¸­...</p>
    </div>

    <script>
        // æ•°æ®åŠ è½½
        async function loadData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Artistkisa/kisara-viz-center/main/data/huinan-data.json');
                const data = await response.json();
                return data;
            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                return null;
            }
        }
        
        // åŠ è½½å†å²æ•°æ®
        async function loadHistory() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Artistkisa/kisara-viz-center/main/data/huinan-detailed.json');
                const data = await response.json();
                return data.records || [];
            } catch (e) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', e);
                return [];
            }
        }
        
        // åˆå§‹åŒ–ä¸»å›¾ï¼ˆChart.jsï¼‰
        function initMainChart(records) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // å‡†å¤‡æ•°æ®
            const labels = records.map(r => {
                const dt = new Date(r.time);
                return `${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
            });
            const humidityData = records.map(r => r.humidity);
            const tempData = records.map(r => r.temp);
            const dewData = records.map(r => r.dew);
            const confidenceData = records.map(r => r.confidence?.score || 0);
            const coreTriggerData = records.map(r => r.coreTrigger?.allOK ? 1 : 0);
            
            // è®¡ç®—å›å—å¤©åŒºåŸŸèƒŒæ™¯
            const nanhuiRegions = [];
            let startIdx = null;
            let isFormal = false;
            
            for (let i = 0; i < records.length; i++) {
                const isNanhui = records[i].coreTrigger?.allOK;
                const confidence = records[i].confidence?.score || 0;
                
                if (isNanhui && startIdx === null) {
                    startIdx = i;
                    isFormal = confidence >= 1;
                } else if ((!isNanhui || i === records.length - 1) && startIdx !== null) {
                    nanhuiRegions.push({
                        start: startIdx,
                        end: i,
                        formal: isFormal
                    });
                    startIdx = null;
                }
            }
            
            // åˆ›å»ºç½®ä¿¡åº¦è‰²å¸¦æ•°æ®é›†
            const confidenceBands = confidenceData.map((score, idx) => ({
                x: labels[idx],
                y: score
            }));
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ¹¿åº¦ (%)',
                            data: humidityData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'æ¸©åº¦ (Â°C)',
                            data: tempData,
                            borderColor: '#feca57',
                            backgroundColor: 'rgba(254, 202, 87, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#feca57',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'éœ²ç‚¹ (Â°C)',
                            data: dewData,
                            borderColor: '#00c853',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#00c853',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 46, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#8892b0',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                afterBody: function(context) {
                                    const idx = context[0].dataIndex;
                                    const r = records[idx];
                                    if (r.coreTrigger?.allOK) {
                                        return `âš ï¸ å›å—å¤©æ¡ä»¶æ»¡è¶³\nç½®ä¿¡åº¦: ${r.confidence?.score || 0}/3`;
                                    }
                                    return '';
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 85,
                                    yMax: 85,
                                    borderColor: '#ff1744',
                                    borderWidth: 2,
                                    borderDash: [10, 5],
                                    label: {
                                        content: '85% è­¦æˆ’çº¿',
                                        enabled: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(255, 23, 68, 0.8)',
                                        color: '#fff',
                                        font: { size: 12 }
                                    }
                                },
                                // åŠ¨æ€æ·»åŠ å›å—å¤©åŒºåŸŸ
                                ...nanhuiRegions.reduce((acc, region, idx) => {
                                    acc[`nanhui${idx}`] = {
                                        type: 'box',
                                        xMin: region.start,
                                        xMax: region.end,
                                        yMin: 0,
                                        yMax: 100,
                                        backgroundColor: region.formal ? 'rgba(147, 112, 219, 0.2)' : 'rgba(147, 112, 219, 0.1)',
                                        borderWidth: 0
                                    };
                                    return acc;
                                }, {})
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
                            ticks: { color: '#8892b0', font: { size: 11 } }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
                            ticks: { color: '#8892b0', font: { size: 10 }, maxRotation: 45 }
                        }
                    }
                }
            });
            
            return chart;
        }
        
        // åˆå§‹åŒ–é£å‘é£é€Ÿå›¾ï¼ˆEChartsï¼‰
        function initWindChart(records) {
            const chart = echarts.init(document.getElementById('windChart'));
            
            const labels = records.map(r => {
                const dt = new Date(r.time);
                return `${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
            });
            const windSpeed = records.map(r => r.windSpeed || 0);
            const windDir = records.map(r => r.windDir || 0);
            
            // è®¡ç®—é£å‘èƒŒæ™¯åŒºåŸŸ
            const windRegions = [];
            let startIdx = null;
            for (let i = 0; i < windDir.length; i++) {
                const isGoodWind = windDir[i] >= 135 && windDir[i] <= 225;
                if (isGoodWind && startIdx === null) {
                    startIdx = i;
                } else if ((!isGoodWind || i === windDir.length - 1) && startIdx !== null) {
                    windRegions.push([{ xAxis: labels[startIdx] }, { xAxis: labels[i] }]);
                    startIdx = null;
                }
            }
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(22,33,62,0.95)',
                    borderColor: '#e94560',
                    textStyle: { color: '#eee' },
                    formatter: function(params) {
                        const idx = params[0].dataIndex;
                        return `${labels[idx]}<br/>é£é€Ÿ: ${windSpeed[idx]} km/h<br/>é£å‘: ${windDir[idx]}Â°`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: labels,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888', fontSize: 10, rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    name: 'é£é€Ÿ(km/h)',
                    min: 0,
                    max: Math.max(...windSpeed) * 1.2 || 10,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [{
                    name: 'é£é€Ÿ',
                    type: 'line',
                    data: windSpeed,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 4,
                    lineStyle: { color: '#00d9ff', width: 2 },
                    areaStyle: { color: 'rgba(0,217,255,0.1)' },
                    itemStyle: { color: '#00d9ff' },
                    markArea: {
                        silent: true,
                        itemStyle: { color: 'rgba(78,204,163,0.15)' },
                        data: windRegions
                    }
                }]
            };
            
            chart.setOption(option);
            return chart;
        }
        
        // åˆå§‹åŒ–æ°”å‹å›¾ï¼ˆEChartsï¼‰
        function initPressureChart(records) {
            const chart = echarts.init(document.getElementById('pressureChart'));
            
            const labels = records.map(r => {
                const dt = new Date(r.time);
                return `${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
            });
            const pressure = records.map(r => r.pressure || 1013);
            
            // è®¡ç®—æ°”å‹å˜åŒ–é¢œè‰²
            const pressureData = pressure.map((p, idx) => {
                let color = '#00d9ff';
                if (idx > 0) {
                    color = p >= pressure[idx-1] ? '#e94560' : '#4ecca3';
                }
                return {
                    value: p,
                    itemStyle: { color: color }
                };
            });
            
            const minP = Math.min(...pressure);
            const maxP = Math.max(...pressure);
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(22,33,62,0.95)',
                    borderColor: '#e94560',
                    textStyle: { color: '#eee' }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: labels,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888', fontSize: 10, rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ°”å‹(hPa)',
                    min: Math.max(minP - 5, 980),
                    max: Math.min(maxP + 5, 1040),
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [{
                    name: 'æ°”å‹',
                    type: 'line',
                    data: pressureData,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 4,
                    lineStyle: { width: 2 }
                }]
            };
            
            chart.setOption(option);
            return chart;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(data) {
            if (!data) return;
            
            document.getElementById('humidityValue').textContent = (data.humidity || '--') + '%';
            document.getElementById('dewValue').textContent = (data.dew || '--') + 'Â°C';
            document.getElementById('tempValue').textContent = (data.temp || '--') + 'Â°C';
            document.getElementById('confidenceValue').textContent = (data.confidence?.score || '-') + '/3';
            
            // æ›´æ–°çŠ¶æ€å¡ç‰‡
            const card = document.getElementById('statusCard');
            const isNanhui = data.coreTrigger?.allOK;
            const level = data.intensity?.level;
            
            card.className = 'status-card';
            if (isNanhui) {
                card.classList.add(level || 'mild', 'pulse');
                document.querySelector('.status-icon').textContent = 'ğŸŒ«ï¸';
                document.querySelector('.status-text').textContent = 
                    level === 'severe' ? 'é‡åº¦å›å—å¤©' :
                    level === 'moderate' ? 'ä¸­åº¦å›å—å¤©' : 'è½»åº¦å›å—å¤©';
            } else {
                card.classList.add('normal');
                document.querySelector('.status-icon').textContent = 'â˜€ï¸';
                document.querySelector('.status-text').textContent = 'æ­£å¸¸';
            }
            
            document.getElementById('updateTime').textContent = 
                'æœ€åæ›´æ–°: ' + (data.time || new Date().toLocaleString('zh-CN'));
        }
        
        // ä¸»å‡½æ•°
        async function main() {
            const [data, records] = await Promise.all([loadData(), loadHistory()]);
            
            updateStatus(data);
            
            if (records.length >= 2) {
                const mainChart = initMainChart(records);
                const windChart = initWindChart(records);
                const pressureChart = initPressureChart(records);
                
                // è”åŠ¨
                window.addEventListener('resize', () => {
                    mainChart.resize();
                    windChart.resize();
                    pressureChart.resize();
                });
            } else {
                document.querySelector('.chart-container').innerHTML = 
                    '<div style="text-align:center;color:#8892b0;padding:50px;">æ•°æ®æ”¶é›†ä¸­ï¼Œè¯·ç¨åå†æŸ¥çœ‹...</div>';
            }
        }
        
        main();
    </script>
</body>
</html>
