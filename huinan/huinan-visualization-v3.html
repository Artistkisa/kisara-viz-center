<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿å·å›å—å¤©ç›‘æµ‹ - v3</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #1a1a2e; 
            color: #eee; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #fff; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; font-size: 14px; }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #888;
            text-decoration: none;
        }
        .back-link:hover { color: #fff; }
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #16213e;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }
        .stat-value { font-size: 28px; font-weight: bold; color: #00d9ff; }
        .stat-label { font-size: 12px; color: #888; margin-top: 5px; }
        .stat-value.loading { color: #666; }
        .chart-container {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .main-chart { height: 400px; }
        .sub-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .sub-chart { height: 200px; }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 10px; border-radius: 2px; }
        .confidence-legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 11px;
        }
        .conf-item { display: flex; align-items: center; gap: 3px; }
        .conf-box { width: 15px; height: 8px; }
        .error-msg {
            text-align: center;
            color: #ff6b6b;
            padding: 20px;
        }
        .update-time {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="./" class="back-link">â† è¿”å›å›å—å¤©é¦–é¡µ</a>
        <h1>ğŸŒ«ï¸ å¹¿å·å›å—å¤©ç›‘æµ‹</h1>
        <p class="subtitle">å…­æ­¥ç®—æ³•ï¼šæ ¸å¿ƒè§¦å‘ â†’ ç½®ä¿¡åº¦è¯„åˆ† â†’ å¼ºåº¦åˆ†çº§ â†’ é˜²æŠ– â†’ é€šçŸ¥ â†’ ç»Ÿè®¡</p>
        
        <div class="stats" id="statsContainer">
            <div class="stat-item">
                <div class="stat-value loading">--</div>
                <div class="stat-label">æ•°æ®ç‚¹æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value loading">--</div>
                <div class="stat-label">æœ€é«˜ç½®ä¿¡åº¦</div>
            </div>
            <div class="stat-item">
                <div class="stat-value loading">--</div>
                <div class="stat-label">å½“å‰æ¹¿åº¦</div>
            </div>
        </div>
        <div class="update-time" id="updateTime">åŠ è½½ä¸­...</div>
        <div class="chart-container">
            <div id="mainChart" class="main-chart"></div>
            
            <div class="confidence-legend">
                <span style="color:#888">ç½®ä¿¡åº¦ï¼š</span>
                <div class="conf-item"><div class="conf-box" style="background:#666"></div><span>0åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#87ceeb"></div><span>1åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#4169e1"></div><span>2åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#000080"></div><span>3åˆ†</span></div>
            </div>
            
            <div class="sub-charts">
                <div id="windChart" class="sub-chart"></div>
                <div id="pressureChart" class="sub-chart"></div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background:#5470c6"></div><span>æ¹¿åº¦</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#91cc75"></div><span>æ¸©åº¦</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#fac858"></div><span>éœ²ç‚¹</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#e94560"></div><span>85%åŸºçº¿</span></div>
            <div class="legend-item"><div class="legend-color" style="background:rgba(147,112,219,0.5)"></div><span>æ­£å¼å›å—å¤©</span></div>
            <div class="legend-item"><div class="legend-color" style="background:rgba(147,112,219,0.2)"></div><span>ç–‘ä¼¼å›å—å¤©</span></div>
        </div>
    </div>

    <script>
        // æ•°æ®åŠ è½½
        async function loadData() {
            try {
                // åŠ è½½è¯¦ç»†å†å²æ•°æ®
                const detailedResponse = await fetch('../data/huinan-detailed.json');
                const detailedData = await detailedResponse.json();
                
                // åŠ è½½å½“å‰æ•°æ®
                const currentResponse = await fetch('../data/huinan-data.json');
                const currentData = await currentResponse.json();
                
                return { detailed: detailedData, current: currentData };
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('statsContainer').innerHTML = 
                    '<div class="error-msg">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                return null;
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            if (!timeStr) return '';
            // å¤„ç† ISO æ ¼å¼
            if (timeStr.includes('T')) {
                const dt = new Date(timeStr);
                return `${(dt.getMonth()+1).toString().padStart(2,'0')}-${dt.getDate().toString().padStart(2,'0')} ${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;
            }
            // å¤„ç†æ™®é€šæ ¼å¼
            const parts = timeStr.split(' ');
            if (parts.length === 2) {
                const dateParts = parts[0].split('-');
                return `${dateParts[1]}-${dateParts[2]} ${parts[1].substring(0,5)}`;
            }
            return timeStr;
        }
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStats(detailedData, currentData) {
            const records = detailedData.records || [];
            const statsContainer = document.getElementById('statsContainer');
            
            // æ•°æ®ç‚¹æ•°
            const dataCount = records.length;
            
            // æœ€é«˜ç½®ä¿¡åº¦
            const maxConfidence = records.length > 0 
                ? Math.max(...records.map(r => r.confidence?.score || 0))
                : 0;
            
            // å½“å‰æ¹¿åº¦
            const currentHumidity = currentData.humidity || 0;
            
            // æ›´æ–°æ—¶é—´
            const updateTime = currentData.updatedAt 
                ? new Date(currentData.updatedAt).toLocaleString('zh-CN')
                : 'æœªçŸ¥';
            
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${dataCount}</div>
                    <div class="stat-label">æ•°æ®ç‚¹æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${maxConfidence}/3</div>
                    <div class="stat-label">æœ€é«˜ç½®ä¿¡åº¦</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: ${currentHumidity > 80 ? '#ff6b6b' : '#00d9ff'}">${currentHumidity}%</div>
                    <div class="stat-label">å½“å‰æ¹¿åº¦</div>
                </div>
            `;
            
            document.getElementById('updateTime').textContent = `æœ€åæ›´æ–°: ${updateTime}`;
        }
        
        // æ¸²æŸ“å›¾è¡¨
        function renderCharts(detailedData) {
            const records = detailedData.records || [];
            
            // æå–æ•°æ®
            const times = records.map(r => formatTime(r.time));
            const humidity = records.map(r => r.humidity);
            const temp = records.map(r => r.temp);
            const dew = records.map(r => r.dew);
            const windDir = records.map(r => r.windDir);
            const windSpeed = records.map(r => r.windSpeed);
            const pressure = records.map(r => r.pressure);
            const confidenceScores = records.map(r => r.confidence?.score || 0);
            const coreTriggers = records.map(r => r.coreTrigger || {});
            const intensityLevels = records.map(r => r.intensity?.level || 'none');
            
            // è®¡ç®—å›å—å¤©åŒºåŸŸ
            const nanhuiRegions = [];
            let startIdx = null;
            let isFormal = false;
            let level = 'none';
            
            for (let i = 0; i < times.length; i++) {
                const isNanhui = coreTriggers[i].allOK;
                const currentLevel = intensityLevels[i];
                const confidence = confidenceScores[i];
                
                if (isNanhui && startIdx === null) {
                    startIdx = i;
                    isFormal = confidence >= 1;
                    level = currentLevel;
                } else if ((!isNanhui || i === times.length - 1) && startIdx !== null) {
                    nanhuiRegions.push({
                        start: times[startIdx],
                        end: times[i],
                        formal: isFormal,
                        level: level
                    });
                    startIdx = null;
                }
            }
            
            // ä¸»å›¾
            const mainChart = echarts.init(document.getElementById('mainChart'));
            const mainOption = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(22,33,62,0.95)',
                    borderColor: '#e94560',
                    textStyle: { color: '#eee' }
                },
                legend: {
                    data: ['æ¹¿åº¦', 'æ¸©åº¦', 'éœ²ç‚¹', '85%åŸºçº¿'],
                    textStyle: { color: '#eee' },
                    top: 10
                },
                grid: {
                    left: '3%', right: '4%', bottom: '12%', top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { 
                        color: '#888',
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ•°å€¼',
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [
                    {
                        name: 'æ¹¿åº¦',
                        type: 'line',
                        data: humidity,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#5470c6', width: 2 },
                        itemStyle: { color: '#5470c6' }
                    },
                    {
                        name: 'æ¸©åº¦',
                        type: 'line',
                        data: temp,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#91cc75', width: 2 },
                        itemStyle: { color: '#91cc75' }
                    },
                    {
                        name: 'éœ²ç‚¹',
                        type: 'line',
                        data: dew,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#fac858', width: 2 },
                        itemStyle: { color: '#fac858' }
                    },
                    {
                        name: '85%åŸºçº¿',
                        type: 'line',
                        data: times.map(() => 85),
                        lineStyle: { color: '#e94560', type: 'dashed', width: 1 },
                        symbol: 'none',
                        silent: true
                    }
                ]
            };
            
            // æ·»åŠ å›å—å¤©é«˜äº®åŒºåŸŸ
            nanhuiRegions.forEach(region => {
                mainOption.series.push({
                    type: 'line',
                    markArea: {
                        silent: true,
                        itemStyle: {
                            color: region.formal ? 'rgba(147,112,219,0.3)' : 'rgba(147,112,219,0.15)'
                        },
                        data: [[
                            { xAxis: region.start },
                            { xAxis: region.end }
                        ]]
                    },
                    data: []
                });
            });
            
            mainChart.setOption(mainOption);
            
            // é£å‘é£é€Ÿå›¾
            const windChart = echarts.init(document.getElementById('windChart'));
            const windOption = {
                backgroundColor: 'transparent',
                title: { text: 'é£é€Ÿå˜åŒ–', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: { trigger: 'axis', backgroundColor: 'rgba(22,33,62,0.95)', textStyle: { color: '#eee' } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888', fontSize: 9, rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    name: 'km/h',
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [{
                    name: 'é£é€Ÿ',
                    type: 'bar',
                    data: windSpeed,
                    itemStyle: { color: '#87ceeb' }
                }]
            };
            windChart.setOption(windOption);
            
            // æ°”å‹å›¾
            const pressureChart = echarts.init(document.getElementById('pressureChart'));
            const pressureOption = {
                backgroundColor: 'transparent',
                title: { text: 'æ°”å‹å˜åŒ–', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: { trigger: 'axis', backgroundColor: 'rgba(22,33,62,0.95)', textStyle: { color: '#eee' } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888', fontSize: 9, rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    name: 'hPa',
                    min: 1000,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [{
                    name: 'æ°”å‹',
                    type: 'line',
                    data: pressure,
                    smooth: true,
                    lineStyle: { color: '#ff9f7f' },
                    itemStyle: { color: '#ff9f7f' }
                }]
            };
            pressureChart.setOption(pressureOption);
            
            // å“åº”å¼
            window.addEventListener('resize', () => {
                mainChart.resize();
                windChart.resize();
                pressureChart.resize();
            });
        }
        
        // åˆå§‹åŒ–
        async function init() {
            const data = await loadData();
            if (data) {
                updateStats(data.detailed, data.current);
                renderCharts(data.detailed);
            }
        }
        
        init();
    </script>
</body>
</html>
