<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿å·å›å—å¤©ç›‘æµ‹ - v3</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #1a1a2e; 
            color: #eee; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #fff; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; font-size: 14px; }
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #16213e;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: #00d9ff; }
        .stat-label { font-size: 12px; color: #888; margin-top: 5px; }
        .chart-container {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .main-chart { height: 400px; }
        .sub-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .sub-chart { height: 200px; }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 10px; border-radius: 2px; }
        .confidence-legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 11px;
        }
        .conf-item { display: flex; align-items: center; gap: 3px; }
        .conf-box { width: 15px; height: 8px; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            border-bottom: 1px solid #333;
            text-align: center;
        }
        .data-table th {
            background: #1a1a2e;
            text-align: left;
        }
        .data-table tr:nth-child(even) {
            background: #1a1a2e;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ«ï¸ å¹¿å·å›å—å¤©ç›‘æµ‹</h1>
        <p class="subtitle">å…­æ­¥ç®—æ³•ï¼šæ ¸å¿ƒè§¦å‘ â†’ ç½®ä¿¡åº¦è¯„åˆ† â†’ å¼ºåº¦åˆ†çº§ â†’ é˜²æŠ– â†’ é€šçŸ¥ â†’ ç»Ÿè®¡</p>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="statCount">8</div>
                <div class="stat-label">æ•°æ®ç‚¹æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statConfidence">-</div>
                <div class="stat-label">æœ€é«˜ç½®ä¿¡åº¦</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statHumidity">62%</div>
                <div class="stat-label">å½“å‰æ¹¿åº¦</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statSources">-</div>
                <div class="stat-label">æ•°æ®æº</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statConflict">-</div>
                <div class="stat-label">æ•°æ®ä¸€è‡´æ€§</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div id="mainChart" class="main-chart"></div>
            
            <div class="confidence-legend">
                <span style="color:#888">ç½®ä¿¡åº¦ï¼š</span>
                <div class="conf-item"><div class="conf-box" style="background:#3a3a5c"></div><span>0åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#87ceeb"></div><span>1åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#4169e1"></div><span>2åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#000080"></div><span>3åˆ†</span></div>
            </div>
            
            <div class="sub-charts">
                <div id="windChart" class="sub-chart"></div>
                <div id="pressureChart" class="sub-chart"></div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background:#5470c6"></div><span>æ¹¿åº¦</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#91cc75"></div><span>æ¸©åº¦</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#fac858"></div><span>éœ²ç‚¹</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#e94560"></div><span>85%åŸºçº¿</span></div>
            <div class="legend-item"><div class="legend-color" style="background:rgba(147,112,219,0.5)"></div><span>æ­£å¼å›å—å¤©</span></div>
            <div class="legend-item"><div class="legend-color" style="background:rgba(147,112,219,0.2)"></div><span>ç–‘ä¼¼å›å—å¤©</span></div>
        </div>
        
        <div style="max-width: 1400px; margin: 20px auto; padding: 15px; background: #16213e; border-radius: 8px; text-align: center;">
            <p style="color: #888; font-size: 13px; margin-bottom: 10px;">
                ğŸ“Š æ•°æ®æ¥æºï¼šå’Œé£å¤©æ°” + Open-Meteo åŒæºèåˆ
            </p>
            <p style="color: #666; font-size: 11px;">
                èåˆç­–ç•¥ï¼šå·®å¼‚&lt;5%ç­‰æƒå¹³å‡ | 5-10%å’Œé£åŠ æƒ70% | &gt;10%å’Œé£ä¼˜å…ˆ85%å¹¶æ ‡è®°å†²çª
            </p>
        </div>
    </div>

    <script>
        // ä»JSONæ–‡ä»¶å¼‚æ­¥åŠ è½½æ•°æ®
        async function loadChartData() {
            try {
                const response = await fetch('data.json');
                const data = await response.json();
                return data;
            } catch (err) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
                document.getElementById('mainChart').innerHTML = '<div class="loading">åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                return null;
            }
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        async function initCharts() {
            const data = await loadChartData();
            if (!data || !data.records || data.records.length === 0) return;
            
            const records = data.records;
            
            // æå–æ•°æ®
            const times = records.map(r => r._formatted_time || r.time);
            const humidity = records.map(r => r.humidity);
            const temp = records.map(r => r.temp);
            const dew = records.map(r => r.dew);
            const windDir = records.map(r => r.windDir || 0);
            const windSpeed = records.map(r => r.windSpeed || 0);
            const pressure = records.map(r => r.pressure);
            
            // å¤„ç†ç½®ä¿¡åº¦
            const confidenceScores = records.map(r => {
                const conf = r.confidence;
                if (typeof conf === 'number') return conf;
                if (typeof conf === 'string') {
                    const map = {'high': 3, 'medium': 2, 'low': 1};
                    return map[conf] || 0;
                }
                return 0;
            });
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('statCount').textContent = records.length;
            document.getElementById('statConfidence').textContent = Math.max(...confidenceScores) + '/3';
            
            const latest = records[records.length - 1];
            document.getElementById('statHumidity').textContent = latest.humidity + '%';
            document.getElementById('statSources').textContent = latest.source_count || 1;
            document.getElementById('statSources').style.color = (latest.source_count || 1) >= 2 ? '#4ecca3' : '#fac858';
            document.getElementById('statConflict').textContent = latest.conflict ? 'âš ï¸' : 'âœ“';
            document.getElementById('statConflict').style.color = latest.conflict ? '#e94560' : '#4ecca3';
            
            // è®¡ç®—æ ¸å¿ƒè§¦å‘
            const coreTriggers = records.map(r => ({
                allOK: r.coreTrigger?.allOK || false,
                humidityOK: r.coreTrigger?.humidityOK || false,
                dewDiffOK: r.coreTrigger?.dewDiffOK || false,
                humidityTrendOK: r.coreTrigger?.humidityTrendOK || false,
                tempDewDiff: r.coreTrigger?.tempDewDiff || 0
            }));
            
            const intensityLevels = records.map(r => r.intensity?.level || 'none');
            
            // è®¡ç®—å›å—å¤©åŒºåŸŸ
            const nanhuiRegions = [];
            let startIdx = null;
            let isFormal = false;
            let level = 'none';
            
            for (let i = 0; i < times.length; i++) {
                const isNanhui = coreTriggers[i].allOK;
                const currentLevel = intensityLevels[i];
                const confidence = confidenceScores[i];
                
                if (isNanhui && startIdx === null) {
                    startIdx = i;
                    isFormal = confidence >= 1;
                    level = currentLevel;
                } else if ((!isNanhui || i === times.length - 1) && startIdx !== null) {
                    nanhuiRegions.push({
                        start: times[startIdx],
                        end: times[i],
                        formal: isFormal,
                        level: level
                    });
                    startIdx = null;
                }
            }
            
            // è®¡ç®—Yè½´èŒƒå›´
            const windMax = Math.max(...windSpeed, 10) * 1.2;
            const pressureMin = Math.max(Math.min(...pressure) - 5, 980);
            const pressureMax = Math.min(Math.max(...pressure) + 5, 1040);
            
            // ä¸»å›¾
            const mainChart = echarts.init(document.getElementById('mainChart'));
            const mainOption = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(22,33,62,0.95)',
                    borderColor: '#e94560',
                    textStyle: { color: '#eee' }
                },
                legend: {
                    data: ['æ¹¿åº¦', 'æ¸©åº¦', 'éœ²ç‚¹', '85%åŸºçº¿'],
                    textStyle: { color: '#eee' },
                    top: 10
                },
                grid: {
                    left: '3%', right: '4%', bottom: '12%', top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888', rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ•°å€¼',
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [
                    {
                        name: 'æ¹¿åº¦',
                        type: 'line',
                        data: humidity,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#5470c6', width: 2 },
                        itemStyle: { color: '#5470c6' }
                    },
                    {
                        name: 'æ¸©åº¦',
                        type: 'line',
                        data: temp,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#91cc75', width: 2 },
                        itemStyle: { color: '#91cc75' }
                    },
                    {
                        name: 'éœ²ç‚¹',
                        type: 'line',
                        data: dew,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: { color: '#fac858', width: 2 },
                        itemStyle: { color: '#fac858' }
                    },
                    {
                        name: '85%åŸºçº¿',
                        type: 'line',
                        data: times.map(() => 85),
                        lineStyle: { color: '#e94560', type: 'dashed', width: 1 },
                        symbol: 'none',
                        silent: true
                    }
                ]
            };
            
            // æ·»åŠ å›å—å¤©åŒºåŸŸ
            nanhuiRegions.forEach(region => {
                mainOption.series.push({
                    type: 'line',
                    markArea: {
                        silent: true,
                        itemStyle: {
                            color: region.formal ? 'rgba(147,112,219,0.3)' : 'rgba(147,112,219,0.15)'
                        },
                        data: [[{ xAxis: region.start }, { xAxis: region.end }]]
                    },
                    data: []
                });
            });
            
            // æ·»åŠ ç½®ä¿¡åº¦è‰²å¸¦
            const confColors = ['#3a3a5c', '#87ceeb', '#4169e1', '#000080'];
            confidenceScores.forEach((score, idx) => {
                if (idx < times.length - 1) {
                    mainOption.series.push({
                        type: 'line',
                        markArea: {
                            silent: true,
                            itemStyle: { color: confColors[score] || '#3a3a5c' },
                            data: [[{ xAxis: times[idx] }, { xAxis: times[idx + 1] }]]
                        },
                        data: []
                    });
                }
            });
            
            mainChart.setOption(mainOption);
            
            // é£å‘é£é€Ÿå›¾
            const windChart = echarts.init(document.getElementById('windChart'));
            const windMarkAreas = [];
            let windStartIdx = null;
            for (let i = 0; i < windDir.length; i++) {
                const isGoodWind = windDir[i] >= 135 && windDir[i] <= 225;
                if (isGoodWind && windStartIdx === null) {
                    windStartIdx = i;
                } else if ((!isGoodWind || i === windDir.length - 1) && windStartIdx !== null) {
                    windMarkAreas.push([{ xAxis: times[windStartIdx] }, { xAxis: times[i] }]);
                    windStartIdx = null;
                }
            }
            
            const windOption = {
                backgroundColor: 'transparent',
                title: { text: 'é£å‘é£é€Ÿ', left: 'center', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(22,33,62,0.95)',
                    borderColor: '#e94560',
                    textStyle: { color: '#eee' },
                    formatter: function(params) {
                        const idx = params[0].dataIndex;
                        return times[idx] + '<br/>é£é€Ÿ: ' + windSpeed[idx] + ' km/h<br/>é£å‘: ' + windDir[idx] + 'Â°';
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '25%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { show: false }
                },
                yAxis: {
                    type: 'value',
                    name: 'é£é€Ÿ(km/h)',
                    min: 0,
                    max: Math.max(windMax, 5),
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [{
                    name: 'é£é€Ÿ',
                    type: 'line',
                    data: windSpeed,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 3,
                    lineStyle: { color: '#00d9ff', width: 2 },
                    areaStyle: { color: 'rgba(0,217,255,0.1)' },
                    markArea: {
                        silent: true,
                        itemStyle: { color: 'rgba(78,204,163,0.2)' },
                        data: windMarkAreas
                    }
                }]
            };
            windChart.setOption(windOption);
            
            // æ°”å‹å›¾
            const pressureChart = echarts.init(document.getElementById('pressureChart'));
            const pressureData = pressure.map((p, idx) => {
                let color = '#00d9ff';
                if (idx > 0) color = p >= pressure[idx-1] ? '#e94560' : '#4ecca3';
                return { value: p, itemStyle: { color: color }, lineStyle: { color: color } };
            });
            
            const pressureOption = {
                backgroundColor: 'transparent',
                title: { text: 'æ°”å‹', left: 'center', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(22,33,62,0.95)',
                    borderColor: '#e94560',
                    textStyle: { color: '#eee' }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '25%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { show: false }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ°”å‹(hPa)',
                    min: pressureMin,
                    max: pressureMax,
                    axisLine: { lineStyle: { color: '#555' } },
                    axisLabel: { color: '#888' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: [{
                    name: 'æ°”å‹',
                    type: 'line',
                    data: pressureData,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 3,
                    lineStyle: { width: 2 }
                }]
            };
            pressureChart.setOption(pressureOption);
            
            echarts.connect([mainChart, windChart, pressureChart]);
            
            window.addEventListener('resize', () => {
                mainChart.resize();
                windChart.resize();
                pressureChart.resize();
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        initCharts();
    </script>
    
    <!-- æ•°æ®å¯¹æ¯”åŒºåŸŸ -->
    <div id="dataComparison" style="max-width: 1400px; margin: 40px auto 20px; padding: 20px; background: #16213e; border-radius: 12px;">
        <h3 style="color: #fff; margin-bottom: 20px; text-align: center;">ğŸ“Š å¤šæºæ•°æ®å¯¹æ¯”ä¸èåˆè®¡ç®—</h3>
        <div id="comparisonContent" style="color: #eee;">
            <p style="text-align: center; color: #888;">åŠ è½½ä¸­...</p>
        </div>
    </div>
    
    <script src="comparison.js?v=3"></script>
    
    <!-- è®¢é˜…åŒºåŸŸ -->
    <div style="max-width: 1400px; margin: 40px auto 20px; padding: 20px; background: #16213e; border-radius: 12px; text-align: center;">
        <h3 style="color: #fff; margin-bottom: 15px;">ğŸ“§ è®¢é˜…å›å—å¤©é¢„è­¦</h3>
        <p style="color: #888; margin-bottom: 20px; font-size: 14px;">å½“å¹¿å·å‡ºç°å›å—å¤©å¤©æ°”æ—¶ï¼Œè‡ªåŠ¨å‘é€é‚®ä»¶é€šçŸ¥</p>
        <form id="subscribeForm" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <input type="email" id="emailInput" placeholder="è¾“å…¥æ‚¨çš„é‚®ç®±" required 
                style="padding: 12px 20px; border: 1px solid #333; border-radius: 6px; background: #1a1a2e; color: #fff; min-width: 250px; font-size: 14px;">
            <button type="submit" 
                style="padding: 12px 30px; background: #667eea; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s;">
                è®¢é˜…
            </button>
        </form>
        <p id="subscribeMsg" style="margin-top: 15px; font-size: 13px; color: #4ecca3; display: none;"></p>
        <p style="margin-top: 20px; font-size: 12px; color: #555;">
            <a href="#" id="unsubscribeLink" style="color: #667eea; text-decoration: none;">é€€è®¢</a>
        </p>
    </div>
    
    <script>
        document.getElementById('subscribeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const msg = document.getElementById('subscribeMsg');
            
            try {
                const formData = new URLSearchParams();
                formData.append('email', email);
                formData.append('type', 'huinan');
                
                const response = await fetch('https://www.kisara.art/subscribe.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                const data = await response.json();
                
                msg.style.display = 'block';
                if (data.success) {
                    msg.style.color = '#4ecca3';
                    msg.textContent = 'âœ… è®¢é˜…æˆåŠŸï¼æ‚¨å°†æ”¶åˆ°å›å—å¤©é¢„è­¦é‚®ä»¶ã€‚';
                    document.getElementById('emailInput').value = '';
                } else {
                    msg.style.color = '#e94560';
                    msg.textContent = 'âŒ ' + (data.message || data.error || 'è®¢é˜…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (err) {
                msg.style.display = 'block';
                msg.style.color = '#e94560';
                msg.textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            }
        });
        
        document.getElementById('unsubscribeLink').addEventListener('click', (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            if (email) {
                window.open('https://www.kisara.art/unsubscribe.php?email=' + encodeURIComponent(email), '_blank');
            } else {
                alert('è¯·å…ˆè¾“å…¥è¦é€€è®¢çš„é‚®ç®±åœ°å€');
                document.getElementById('emailInput').focus();
            }
        });
    </script>
</body>
</html>