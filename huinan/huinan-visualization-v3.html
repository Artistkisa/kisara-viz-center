<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›å—å¤©ç›‘æµ‹ - å¹¿å· (V3åŠ¨æ€ç‰ˆ)</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.3rem;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #8892b0;
            text-decoration: none;
        }
        .back-link:hover { color: #fff; }
        
        /* çŠ¶æ€å¡ç‰‡ */
        .status-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            border: 3px solid;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .status-card.normal { border-color: #00c853; background: rgba(0,200,83,0.1); }
        .status-card.mild { border-color: #feca57; background: rgba(254,202,87,0.1); }
        .status-card.moderate { border-color: #ff9800; background: rgba(255,152,0,0.1); }
        .status-card.severe { border-color: #ff1744; background: rgba(255,23,68,0.1); }
        
        .status-icon { font-size: 5rem; margin-bottom: 15px; }
        .status-text { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .status-card.normal .status-text { color: #00c853; }
        .status-card.mild .status-text { color: #feca57; }
        .status-card.moderate .status-text { color: #ff9800; }
        .status-card.severe .status-text { color: #ff1744; }
        .status-desc { color: #8892b0; }
        
        /* å®æ—¶æ•°æ®å¡ç‰‡ */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }
        .metric:hover { transform: translateY(-5px); }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .metric-value.warning { background: linear-gradient(90deg, #ff9800 0%, #ff1744 100%); -webkit-background-clip: text; }
        .metric-label { color: #8892b0; margin-top: 8px; font-size: 0.95rem; }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .chart-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chart-container { position: relative; height: 400px; margin-bottom: 20px; }
        .confidence-bar {
            height: 12px;
            background: linear-gradient(to right, #666 0%, #666 25%, #87ceeb 25%, #87ceeb 50%, #4169e1 50%, #4169e1 75%, #000080 75%, #000080 100%);
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .confidence-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #8892b0;
            margin-bottom: 20px;
        }
        
        /* å­å›¾ */
        .sub-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .sub-chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sub-chart { height: 200px; }
        
        /* å¯¼èˆªé“¾æ¥ */
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 12px 24px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }
        
        /* åˆ¤æ–­æ ‡å‡† */
        .info-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .info-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s;
        }
        .info-card:hover { transform: translateY(-3px); border-color: rgba(102, 126, 234, 0.3); }
        .info-card h4 { color: #667eea; margin-bottom: 10px; font-size: 0.95rem; }
        .info-card p { color: #8892b0; font-size: 0.9rem; line-height: 1.5; }
        
        .update-time {
            text-align: center;
            color: #8892b0;
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        .loading { color: #666; }
        .error-msg { text-align: center; color: #ff6b6b; padding: 20px; }
        
        @media (max-width: 768px) {
            .sub-charts { grid-template-columns: 1fr; }
            .metrics { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../" class="back-link">â† è¿”å›ç›‘æ§ä¸­å¿ƒ</a>
        <h1>ğŸŒ«ï¸ å¹¿å·å›å—å¤©ç›‘æµ‹</h1>
        
        <div class="nav-links">
            <a href="./huinan-readme.md" class="nav-btn">ğŸ“– æ•°æ®è¯´æ˜æ–‡æ¡£</a>
            <a href="./huinan-visualization.html" class="nav-btn">ğŸ“Š æ—§ç‰ˆå›¾è¡¨</a>
        </div>
        
        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div id="statusCard" class="status-card normal">
            <div class="status-icon" id="statusIcon">âœ…</div>
            <div class="status-text" id="statusText">æ— å›å—å¤©é£é™©</div>
            <div class="status-desc" id="statusDesc">å½“å‰ç¯å¢ƒæ¡ä»¶è‰¯å¥½</div>
        </div>
        
        <!-- å®æ—¶æ•°æ® -->
        <div class="metrics" id="metrics">
            <div class="metric">
                <div class="metric-value loading" id="humidity">--</div>
                <div class="metric-label">ğŸ’§ ç›¸å¯¹æ¹¿åº¦</div>
            </div>
            <div class="metric">
                <div class="metric-value loading" id="dew">--</div>
                <div class="metric-label">ğŸŒ¡ï¸ éœ²ç‚¹æ¸©åº¦</div>
            </div>
            <div class="metric">
                <div class="metric-value loading" id="temp">--</div>
                <div class="metric-label">ğŸŒ¡ï¸ ç©ºæ°”æ¸©åº¦</div>
            </div>
            <div class="metric">
                <div class="metric-value loading" id="confidence">--</div>
                <div class="metric-label">ğŸ¯ ç½®ä¿¡åº¦</div>
            </div>
        </div>
        
        <!-- å›¾è¡¨ -->
        <div class="chart-section">
            <h2>ğŸ“ˆ æ¸©æ¹¿åº¦è¶‹åŠ¿</h2>
            <div class="confidence-bar"></div>
            <div class="confidence-labels">
                <span>0åˆ†</span>
                <span>1åˆ†</span>
                <span>2åˆ†</span>
                <span>3åˆ†</span>
            </div>
            <div id="mainChart" class="chart-container"></div>
            
            <div class="sub-charts">
                <div class="sub-chart-container">
                    <div id="windChart" class="sub-chart"></div>
                </div>
                <div class="sub-chart-container">
                    <div id="pressureChart" class="sub-chart"></div>
                </div>
            </div>
        </div>
        
        <!-- åˆ¤æ–­æ ‡å‡† -->
        <div class="info-section">
            <h2>ğŸ“‹ å›å—å¤©åˆ¤æ–­æ ‡å‡†</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h4>ğŸŒ¡ï¸ æ ¸å¿ƒè§¦å‘æ¡ä»¶</h4>
                    <p>æ¹¿åº¦ > 85% ä¸” æ¸©åº¦ - éœ²ç‚¹ < 3Â°C</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ¯ ç½®ä¿¡åº¦è¯„åˆ†</h4>
                    <p>0åˆ†ï¼šæ— é£é™© | 1åˆ†ï¼šè½»å¾® | 2åˆ†ï¼šä¸­ç­‰ | 3åˆ†ï¼šä¸¥é‡</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ’¨ é£å‘å½±å“</h4>
                    <p>å—é£ï¼ˆ135Â°-225Â°ï¼‰åŠ å‰§å›å—å¤©ï¼ŒåŒ—é£æœ‰åŠ©äºç¼“è§£</p>
                </div>
                <div class="info-card">
                    <h4>ğŸ“Š æ°”å‹è¶‹åŠ¿</h4>
                    <p>æ°”å‹ä¸‹é™é€šå¸¸ä¼´éšæ¹¿åº¦ä¸Šå‡ï¼Œéœ€æé«˜è­¦æƒ•</p>
                </div>
            </div>
        </div>
        
        <div class="update-time" id="updateTime">åŠ è½½ä¸­...</div>
    </div>

    <script>
        async function loadData() {
            try {
                const detailedRes = await fetch('../data/huinan-detailed.json');
                const detailed = await detailedRes.json();
                const currentRes = await fetch('../data/huinan-data.json');
                const current = await currentRes.json();
                return { detailed, current };
            } catch (e) {
                console.error('åŠ è½½å¤±è´¥:', e);
                return null;
            }
        }

        function formatTime(t) {
            if (!t) return '';
            if (t.includes('T')) {
                const d = new Date(t);
                return `${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            }
            const p = t.split(' ');
            if (p.length === 2) {
                const dp = p[0].split('-');
                return `${dp[1]}-${dp[2]} ${p[1].substring(0,5)}`;
            }
            return t;
        }

        function updateStatusCard(current) {
            const level = current.intensity?.level || 'none';
            const card = document.getElementById('statusCard');
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');
            const desc = document.getElementById('statusDesc');
            
            card.className = 'status-card ' + level;
            
            const statusMap = {
                'none': { icon: 'âœ…', text: 'æ— å›å—å¤©é£é™©', desc: 'å½“å‰ç¯å¢ƒæ¡ä»¶è‰¯å¥½' },
                'mild': { icon: 'âš¡', text: 'è½»åº¦å›å—å¤©', desc: 'æ³¨æ„é˜²æ½®ï¼Œå…³é—­é—¨çª—' },
                'moderate': { icon: 'âš ï¸', text: 'ä¸­åº¦å›å—å¤©', desc: 'å»ºè®®å¼€å¯é™¤æ¹¿è®¾å¤‡' },
                'severe': { icon: 'ğŸš¨', text: 'ä¸¥é‡å›å—å¤©', desc: 'åŠ¡å¿…åšå¥½é˜²æŠ¤æªæ–½' }
            };
            
            const s = statusMap[level] || statusMap['none'];
            icon.textContent = s.icon;
            text.textContent = s.text;
            desc.textContent = s.desc;
        }

        function updateMetrics(current) {
            const hum = current.humidity || 0;
            const dew = current.dew || 0;
            const temp = current.temp || 0;
            const conf = current.confidence?.score || 0;
            
            document.getElementById('humidity').textContent = hum + '%';
            document.getElementById('humidity').className = 'metric-value' + (hum > 80 ? ' warning' : '');
            
            document.getElementById('dew').textContent = dew + 'Â°C';
            document.getElementById('temp').textContent = temp + 'Â°C';
            document.getElementById('confidence').textContent = conf + '/3';
            
            document.getElementById('updateTime').textContent = 'æœ€åæ›´æ–°: ' + (current.updatedAt ? new Date(current.updatedAt).toLocaleString('zh-CN') : 'æœªçŸ¥');
        }

        function renderCharts(detailed) {
            const records = detailed.records || [];
            const times = records.map(r => formatTime(r.time));
            const humidity = records.map(r => r.humidity);
            const temp = records.map(r => r.temp);
            const dew = records.map(r => r.dew);
            const windDir = records.map(r => r.windDir);
            const windSpeed = records.map(r => r.windSpeed);
            const pressure = records.map(r => r.pressure);
            const confidenceScores = records.map(r => r.confidence?.score || 0);
            const coreTriggers = records.map(r => r.coreTrigger || {});
            const intensityLevels = records.map(r => r.intensity?.level || 'none');

            // å›å—å¤©åŒºåŸŸ
            const nanhuiRegions = [];
            let startIdx = null, isFormal = false, level = 'none';
            for (let i = 0; i < times.length; i++) {
                const isNanhui = coreTriggers[i].allOK;
                const currentLevel = intensityLevels[i];
                const confidence = confidenceScores[i];
                if (isNanhui && startIdx === null) {
                    startIdx = i; isFormal = confidence >= 1; level = currentLevel;
                } else if ((!isNanhui || i === times.length - 1) && startIdx !== null) {
                    nanhuiRegions.push({ start: times[startIdx], end: times[i], formal: isFormal, level: level });
                    startIdx = null;
                }
            }

            // ä¸»å›¾
            const mainChart = echarts.init(document.getElementById('mainChart'));
            const mainOption = {
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' }, backgroundColor: 'rgba(22,33,62,0.95)', borderColor: '#e94560', textStyle: { color: '#eee' } },
                legend: { data: ['æ¹¿åº¦', 'æ¸©åº¦', 'éœ²ç‚¹'], textStyle: { color: '#eee' }, top: 10 },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { type: 'category', data: times, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888', rotate: 45, fontSize: 10 } },
                yAxis: { type: 'value', name: 'æ•°å€¼', axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333' } } },
                series: [
                    { name: 'æ¹¿åº¦', type: 'line', data: humidity, smooth: true, symbol: 'circle', symbolSize: 4, lineStyle: { color: '#5470c6', width: 2 }, itemStyle: { color: '#5470c6' } },
                    { name: 'æ¸©åº¦', type: 'line', data: temp, smooth: true, symbol: 'circle', symbolSize: 4, lineStyle: { color: '#91cc75', width: 2 }, itemStyle: { color: '#91cc75' } },
                    { name: 'éœ²ç‚¹', type: 'line', data: dew, smooth: true, symbol: 'circle', symbolSize: 4, lineStyle: { color: '#fac858', width: 2 }, itemStyle: { color: '#fac858' } }
                ]
            };

            nanhuiRegions.forEach(region => {
                mainOption.series.push({
                    type: 'line',
                    markArea: { silent: true, itemStyle: { color: region.formal ? 'rgba(147,112,219,0.3)' : 'rgba(147,112,219,0.15)' }, data: [[{ xAxis: region.start }, { xAxis: region.end }]] },
                    data: []
                });
            });

            mainChart.setOption(mainOption);

            // é£å‘å›¾
            const windChart = echarts.init(document.getElementById('windChart'));
            const windMarkAreas = [];
            let windStartIdx = null;
            for (let i = 0; i < windDir.length; i++) {
                const isGoodWind = windDir[i] >= 135 && windDir[i] <= 225;
                if (isGoodWind && windStartIdx === null) windStartIdx = i;
                else if ((!isGoodWind || i === windDir.length - 1) && windStartIdx !== null) {
                    windMarkAreas.push([{ xAxis: times[windStartIdx] }, { xAxis: times[i] }]);
                    windStartIdx = null;
                }
            }

            windChart.setOption({
                backgroundColor: 'transparent',
                title: { text: 'é£å‘é£é€Ÿ', left: 'center', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: { trigger: 'axis', backgroundColor: 'rgba(22,33,62,0.95)', textStyle: { color: '#eee' }, formatter: (p) => { const i = p[0].dataIndex; return times[i] + '<br/>é£é€Ÿ: ' + windSpeed[i] + ' km/h<br/>é£å‘: ' + windDir[i] + 'Â°'; } },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '25%', containLabel: true },
                xAxis: { type: 'category', data: times, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { show: false } },
                yAxis: { type: 'value', name: 'km/h', min: 0, max: 12, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333' } } },
                series: [{ name: 'é£é€Ÿ', type: 'line', data: windSpeed, smooth: true, symbol: 'circle', symbolSize: 3, lineStyle: { color: '#00d9ff', width: 2 }, areaStyle: { color: 'rgba(0,217,255,0.1)' }, markArea: { silent: true, itemStyle: { color: 'rgba(78,204,163,0.2)' }, data: windMarkAreas } }]
            });

            // æ°”å‹å›¾
            const pressureChart = echarts.init(document.getElementById('pressureChart'));
            const pressureData = pressure.map((p, idx) => {
                let color = '#00d9ff';
                if (idx > 0) color = p >= pressure[idx-1] ? '#e94560' : '#4ecca3';
                return { value: p, itemStyle: { color: color }, lineStyle: { color: color } };
            });

            pressureChart.setOption({
                backgroundColor: 'transparent',
                title: { text: 'æ°”å‹å˜åŒ–', left: 'center', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: { trigger: 'axis', backgroundColor: 'rgba(22,33,62,0.95)', textStyle: { color: '#eee' } },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '25%', containLabel: true },
                xAxis: { type: 'category', data: times, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { show: false } },
                yAxis: { type: 'value', name: 'hPa', min: 1007, max: 1019, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333' } } },
                series: [{ name: 'æ°”å‹', type: 'line', data: pressureData, smooth: true, symbol: 'circle', symbolSize: 3, lineStyle: { width: 2 } }]
            });

            echarts.connect([mainChart, windChart, pressureChart]);
            window.addEventListener('resize', () => { mainChart.resize(); windChart.resize(); pressureChart.resize(); });
        }

        async function init() {
            const data = await loadData();
            if (data) {
                updateStatusCard(data.current);
                updateMetrics(data.current);
                renderCharts(data.detailed);
            } else {
                document.getElementById('statusCard').innerHTML = '<div class="error-msg">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        init();
    </script>
</body>
</html>
