<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿å·å›å—å¤©ç›‘æµ‹ - v3</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #1a1a2e; 
            color: #eee; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #fff; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; font-size: 14px; }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #888;
            text-decoration: none;
        }
        .back-link:hover { color: #fff; }
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #16213e;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }
        .stat-value { font-size: 28px; font-weight: bold; color: #00d9ff; }
        .stat-label { font-size: 12px; color: #888; margin-top: 5px; }
        .stat-value.loading { color: #666; }
        .chart-container {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .main-chart { height: 400px; }
        .sub-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .sub-chart { height: 200px; }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 10px; border-radius: 2px; }
        .confidence-legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 11px;
        }
        .conf-item { display: flex; align-items: center; gap: 3px; }
        .conf-box { width: 15px; height: 8px; }
        .error-msg {
            text-align: center;
            color: #ff6b6b;
            padding: 20px;
        }
        .update-time {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="./" class="back-link">â† è¿”å›å›å—å¤©é¦–é¡µ</a>
        <h1>ğŸŒ«ï¸ å¹¿å·å›å—å¤©ç›‘æµ‹</h1>
        <p class="subtitle">å…­æ­¥ç®—æ³•ï¼šæ ¸å¿ƒè§¦å‘ â†’ ç½®ä¿¡åº¦è¯„åˆ† â†’ å¼ºåº¦åˆ†çº§ â†’ é˜²æŠ– â†’ é€šçŸ¥ â†’ ç»Ÿè®¡</p>
        
        <div class="stats" id="statsContainer">
            <div class="stat-item"><div class="stat-value loading">--</div><div class="stat-label">æ•°æ®ç‚¹æ•°</div></div>
            <div class="stat-item"><div class="stat-value loading">--</div><div class="stat-label">æœ€é«˜ç½®ä¿¡åº¦</div></div>
            <div class="stat-item"><div class="stat-value loading">--</div><div class="stat-label">å½“å‰æ¹¿åº¦</div></div>
        </div>
        <div class="update-time" id="updateTime">åŠ è½½ä¸­...</div>
        
        <div class="chart-container">
            <div id="mainChart" class="main-chart"></div>
            
            <div class="confidence-legend">
                <span style="color:#888">ç½®ä¿¡åº¦ï¼š</span>
                <div class="conf-item"><div class="conf-box" style="background:#666"></div><span>0åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#87ceeb"></div><span>1åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#4169e1"></div><span>2åˆ†</span></div>
                <div class="conf-item"><div class="conf-box" style="background:#000080"></div><span>3åˆ†</span></div>
            </div>
            
            <div class="sub-charts">
                <div id="windChart" class="sub-chart"></div>
                <div id="pressureChart" class="sub-chart"></div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background:#5470c6"></div><span>æ¹¿åº¦</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#91cc75"></div><span>æ¸©åº¦</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#fac858"></div><span>éœ²ç‚¹</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#e94560"></div><span>85%åŸºçº¿</span></div>
            <div class="legend-item"><div class="legend-color" style="background:rgba(147,112,219,0.5)"></div><span>æ­£å¼å›å—å¤©</span></div>
            <div class="legend-item"><div class="legend-color" style="background:rgba(147,112,219,0.2)"></div><span>ç–‘ä¼¼å›å—å¤©</span></div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ -->
        <div class="stats-section" id="statsSection" style="margin-top: 40px; display: none;">
            <h2 style="text-align: center; margin-bottom: 20px; color: #fff;">ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                    <div class="stat-title" style="color: #888; font-size: 12px; margin-bottom: 10px;">ç´¯è®¡ç›‘æµ‹å¤©æ•°</div>
                    <div class="stat-number" id="totalDays" style="font-size: 24px; font-weight: bold; color: #00d9ff;">--</div>
                </div>
                <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                    <div class="stat-title" style="color: #888; font-size: 12px; margin-bottom: 10px;">å›å—å¤©å‘ç”Ÿæ¬¡æ•°</div>
                    <div class="stat-number" id="nanhuiCount" style="font-size: 24px; font-weight: bold; color: #e94560;">--</div>
                </div>
                <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                    <div class="stat-title" style="color: #888; font-size: 12px; margin-bottom: 10px;">å¹³å‡æ¹¿åº¦</div>
                    <div class="stat-number" id="avgHumidity" style="font-size: 24px; font-weight: bold; color: #91cc75;">--</div>
                </div>
                <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                    <div class="stat-title" style="color: #888; font-size: 12px; margin-bottom: 10px;">æœ€é«˜æ¹¿åº¦è®°å½•</div>
                    <div class="stat-number" id="maxHumidity" style="font-size: 24px; font-weight: bold; color: #fac858;">--</div>
                </div>
            </div>
        </div>
        
        <!-- è§£é‡Šå¡ç‰‡ -->
        <div class="info-section" style="margin-top: 40px;">
            <h2 style="text-align: center; margin-bottom: 20px; color: #fff;">ğŸ“– æ•°æ®è¯´æ˜</h2>
            <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="info-card" style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="color: #667eea; margin-bottom: 10px;">ğŸŒ¡ï¸ å…­æ­¥ç®—æ³•</h3>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6;">æ ¸å¿ƒè§¦å‘ â†’ ç½®ä¿¡åº¦è¯„åˆ† â†’ å¼ºåº¦åˆ†çº§ â†’ é˜²æŠ– â†’ é€šçŸ¥ â†’ ç»Ÿè®¡ã€‚é€šè¿‡æ¹¿åº¦ã€éœ²ç‚¹å·®ã€æ°”å‹å˜åŒ–ç­‰å¤šç»´åº¦æ•°æ®ç»¼åˆåˆ¤æ–­å›å—å¤©é£é™©ã€‚</p>
                </div>
                <div class="info-card" style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ’¨ é£å‘å½±å“</h3>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6;">å—é£ï¼ˆ135Â°-225Â°ï¼‰ä¼šåŠ å‰§å›å—å¤©ï¼ŒåŒ—é£æœ‰åŠ©äºç¼“è§£ã€‚å›¾è¡¨ä¸­ç»¿è‰²èƒŒæ™¯è¡¨ç¤ºæœ‰åˆ©äºç¼“è§£å›å—å¤©çš„é£å‘æ—¶æ®µã€‚</p>
                </div>
                <div class="info-card" style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“ˆ ç½®ä¿¡åº¦è¯„åˆ†</h3>
                    <p style="color: #aaa; font-size: 14px; line-height: 1.6;">0åˆ†ï¼šæ— é£é™© | 1åˆ†ï¼šè½»å¾® | 2åˆ†ï¼šä¸­ç­‰ | 3åˆ†ï¼šä¸¥é‡ã€‚è¯„åˆ†åŸºäºæ¹¿åº¦ã€æ¸©å·®ã€æ°”å‹è¶‹åŠ¿ç­‰å¤šä¸ªå› ç´ ç»¼åˆè®¡ç®—ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadData() {
            try {
                const detailedRes = await fetch('../data/huinan-detailed.json');
                const detailed = await detailedRes.json();
                const currentRes = await fetch('../data/huinan-data.json');
                const current = await currentRes.json();
                return { detailed, current };
            } catch (e) {
                console.error('åŠ è½½å¤±è´¥:', e);
                return null;
            }
        }

        function formatTime(t) {
            if (!t) return '';
            if (t.includes('T')) {
                const d = new Date(t);
                return `${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            }
            const p = t.split(' ');
            if (p.length === 2) {
                const dp = p[0].split('-');
                return `${dp[1]}-${dp[2]} ${p[1].substring(0,5)}`;
            }
            return t;
        }

        function updateStats(detailed, current) {
            const records = detailed.records || [];
            const dataCount = records.length;
            const maxConf = records.length ? Math.max(...records.map(r => r.confidence?.score || 0)) : 0;
            const curHum = current.humidity || 0;
            const updTime = current.updatedAt ? new Date(current.updatedAt).toLocaleString('zh-CN') : 'æœªçŸ¥';
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-item"><div class="stat-value">${dataCount}</div><div class="stat-label">æ•°æ®ç‚¹æ•°</div></div>
                <div class="stat-item"><div class="stat-value">${maxConf}/3</div><div class="stat-label">æœ€é«˜ç½®ä¿¡åº¦</div></div>
                <div class="stat-item"><div class="stat-value" style="color:${curHum>80?'#ff6b6b':'#00d9ff'}">${curHum}%</div><div class="stat-label">å½“å‰æ¹¿åº¦</div></div>
            `;
            document.getElementById('updateTime').textContent = `æœ€åæ›´æ–°: ${updTime}`;
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
            calculateDetailedStats(records);
        }

        function calculateDetailedStats(records) {
            if (records.length === 0) return;
            
            // ç´¯è®¡ç›‘æµ‹å¤©æ•°
            const times = records.map(r => new Date(r.time));
            const minTime = new Date(Math.min(...times));
            const maxTime = new Date(Math.max(...times));
            const totalDays = Math.ceil((maxTime - minTime) / (1000 * 60 * 60 * 24)) + 1;
            
            // å›å—å¤©å‘ç”Ÿæ¬¡æ•°ï¼ˆç½®ä¿¡åº¦ >= 2ï¼‰
            const nanhuiCount = records.filter(r => (r.confidence?.score || 0) >= 2).length;
            
            // å¹³å‡æ¹¿åº¦
            const avgHumidity = Math.round(records.reduce((sum, r) => sum + (r.humidity || 0), 0) / records.length);
            
            // æœ€é«˜æ¹¿åº¦
            const maxHumidity = Math.max(...records.map(r => r.humidity || 0));
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('totalDays').textContent = totalDays + 'å¤©';
            document.getElementById('nanhuiCount').textContent = nanhuiCount + 'æ¬¡';
            document.getElementById('avgHumidity').textContent = avgHumidity + '%';
            document.getElementById('maxHumidity').textContent = maxHumidity + '%';
            
            // æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
            document.getElementById('statsSection').style.display = 'block';
        }

        function renderCharts(detailed) {
            const records = detailed.records || [];
            const times = records.map(r => formatTime(r.time));
            const humidity = records.map(r => r.humidity);
            const temp = records.map(r => r.temp);
            const dew = records.map(r => r.dew);
            const windDir = records.map(r => r.windDir);
            const windSpeed = records.map(r => r.windSpeed);
            const pressure = records.map(r => r.pressure);
            const confidenceScores = records.map(r => r.confidence?.score || 0);
            const coreTriggers = records.map(r => r.coreTrigger || {});
            const intensityLevels = records.map(r => r.intensity?.level || 'none');

            // è®¡ç®—å›å—å¤©åŒºåŸŸ
            const nanhuiRegions = [];
            let startIdx = null, isFormal = false, level = 'none';
            for (let i = 0; i < times.length; i++) {
                const isNanhui = coreTriggers[i].allOK;
                const currentLevel = intensityLevels[i];
                const confidence = confidenceScores[i];
                if (isNanhui && startIdx === null) {
                    startIdx = i; isFormal = confidence >= 1; level = currentLevel;
                } else if ((!isNanhui || i === times.length - 1) && startIdx !== null) {
                    nanhuiRegions.push({ start: times[startIdx], end: times[i], formal: isFormal, level: level });
                    startIdx = null;
                }
            }

            // ä¸»å›¾
            const mainChart = echarts.init(document.getElementById('mainChart'));
            const mainOption = {
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' }, backgroundColor: 'rgba(22,33,62,0.95)', borderColor: '#e94560', textStyle: { color: '#eee' } },
                legend: { data: ['æ¹¿åº¦', 'æ¸©åº¦', 'éœ²ç‚¹', '85%åŸºçº¿'], textStyle: { color: '#eee' }, top: 10 },
                grid: { left: '3%', right: '4%', bottom: '12%', top: '15%', containLabel: true },
                xAxis: { type: 'category', data: times, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888', rotate: 45, fontSize: 10 } },
                yAxis: { type: 'value', name: 'æ•°å€¼', axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333' } } },
                series: [
                    { name: 'æ¹¿åº¦', type: 'line', data: humidity, smooth: true, symbol: 'circle', symbolSize: 4, lineStyle: { color: '#5470c6', width: 2 }, itemStyle: { color: '#5470c6' } },
                    { name: 'æ¸©åº¦', type: 'line', data: temp, smooth: true, symbol: 'circle', symbolSize: 4, lineStyle: { color: '#91cc75', width: 2 }, itemStyle: { color: '#91cc75' } },
                    { name: 'éœ²ç‚¹', type: 'line', data: dew, smooth: true, symbol: 'circle', symbolSize: 4, lineStyle: { color: '#fac858', width: 2 }, itemStyle: { color: '#fac858' } },
                    { name: '85%åŸºçº¿', type: 'line', data: times.map(() => 85), lineStyle: { color: '#e94560', type: 'dashed', width: 1 }, symbol: 'none', silent: true }
                ]
            };

            // æ·»åŠ å›å—å¤©é«˜äº®åŒºåŸŸ
            nanhuiRegions.forEach(region => {
                mainOption.series.push({
                    type: 'line',
                    markArea: { silent: true, itemStyle: { color: region.formal ? 'rgba(147,112,219,0.3)' : 'rgba(147,112,219,0.15)' }, data: [[{ xAxis: region.start }, { xAxis: region.end }]] },
                    data: []
                });
            });

            // æ·»åŠ ç½®ä¿¡åº¦è‰²å¸¦
            const confColors = ['#666666', '#87ceeb', '#4169e1', '#000080'];
            confidenceScores.forEach((score, idx) => {
                if (idx < times.length - 1) {
                    mainOption.series.push({
                        type: 'line',
                        markArea: { silent: true, itemStyle: { color: confColors[score] || '#666666' }, data: [[{ xAxis: times[idx] }, { xAxis: times[idx + 1] }]] },
                        data: []
                    });
                }
            });

            mainChart.setOption(mainOption);

            // é£å‘é£é€Ÿå›¾
            const windChart = echarts.init(document.getElementById('windChart'));
            const windMarkAreas = [];
            let windStartIdx = null;
            for (let i = 0; i < windDir.length; i++) {
                const isGoodWind = windDir[i] >= 135 && windDir[i] <= 225;
                if (isGoodWind && windStartIdx === null) windStartIdx = i;
                else if ((!isGoodWind || i === windDir.length - 1) && windStartIdx !== null) {
                    windMarkAreas.push([{ xAxis: times[windStartIdx] }, { xAxis: times[i] }]);
                    windStartIdx = null;
                }
            }

            windChart.setOption({
                backgroundColor: 'transparent',
                title: { text: 'é£å‘é£é€Ÿ', left: 'center', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: { trigger: 'axis', backgroundColor: 'rgba(22,33,62,0.95)', textStyle: { color: '#eee' }, formatter: (p) => { const i = p[0].dataIndex; return times[i] + '<br/>é£é€Ÿ: ' + windSpeed[i] + ' km/h<br/>é£å‘: ' + windDir[i] + 'Â°'; } },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '25%', containLabel: true },
                xAxis: { type: 'category', data: times, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { show: false } },
                yAxis: { type: 'value', name: 'km/h', min: 0, max: 12, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333' } } },
                series: [{ name: 'é£é€Ÿ', type: 'line', data: windSpeed, smooth: true, symbol: 'circle', symbolSize: 3, lineStyle: { color: '#00d9ff', width: 2 }, areaStyle: { color: 'rgba(0,217,255,0.1)' }, markArea: { silent: true, itemStyle: { color: 'rgba(78,204,163,0.2)' }, data: windMarkAreas } }]
            });

            // æ°”å‹å›¾
            const pressureChart = echarts.init(document.getElementById('pressureChart'));
            const pressureData = pressure.map((p, idx) => {
                let color = '#00d9ff';
                if (idx > 0) color = p >= pressure[idx-1] ? '#e94560' : '#4ecca3';
                return { value: p, itemStyle: { color: color }, lineStyle: { color: color } };
            });

            pressureChart.setOption({
                backgroundColor: 'transparent',
                title: { text: 'æ°”å‹', left: 'center', textStyle: { color: '#eee', fontSize: 14 } },
                tooltip: { trigger: 'axis', backgroundColor: 'rgba(22,33,62,0.95)', textStyle: { color: '#eee' } },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '25%', containLabel: true },
                xAxis: { type: 'category', data: times, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { show: false } },
                yAxis: { type: 'value', name: 'hPa', min: 1007, max: 1019, axisLine: { lineStyle: { color: '#555' } }, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333' } } },
                series: [{ name: 'æ°”å‹', type: 'line', data: pressureData, smooth: true, symbol: 'circle', symbolSize: 3, lineStyle: { width: 2 } }]
            });

            echarts.connect([mainChart, windChart, pressureChart]);
            window.addEventListener('resize', () => { mainChart.resize(); windChart.resize(); pressureChart.resize(); });
        }

        async function init() {
            const data = await loadData();
            if (data) {
                updateStats(data.detailed, data.current);
                renderCharts(data.detailed);
            } else {
                document.getElementById('statsContainer').innerHTML = '<div class="error-msg">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        init();
    </script>
</body>
</html>
