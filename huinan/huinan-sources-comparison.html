<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰æºæ•°æ®å¯¹æ¯”ä¸èåˆè¿‡ç¨‹</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: #00d9ff; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #888; font-size: 13px; margin-bottom: 30px; }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }
        
        .time-selector {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .time-selector select {
            background: #16213e;
            color: #00d9ff;
            border: 1px solid #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            min-width: 280px;
        }
        .time-selector button {
            background: #16213e;
            color: #00d9ff;
            border: 1px solid #333;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }
        .time-selector button:hover { background: #1e3a5f; }
        .time-selector button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .source-card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #333;
        }
        .source-card.qw { border-color: #91cc75; }
        .source-card.om { border-color: #fac858; }
        .source-card.yr { border-color: #00d9ff; }
        
        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .source-name { font-size: 18px; font-weight: bold; }
        .source-name.qw { color: #91cc75; }
        .source-name.om { color: #fac858; }
        .source-name.yr { color: #00d9ff; }
        
        .source-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
        }
        .source-status.ok { background: #4ecca333; color: #4ecca3; }
        .source-status.warn { background: #fac85833; color: #fac858; }
        .source-status.err { background: #e9456033; color: #e94560; }
        
        .source-data {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 13px;
        }
        .data-item {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 6px;
        }
        .data-label { color: #888; font-size: 11px; margin-bottom: 3px; }
        .data-value { color: #fff; font-size: 16px; font-weight: bold; }
        .source-note {
            margin-top: 10px;
            padding: 8px;
            background: #1a1a2e;
            border-radius: 6px;
            font-size: 11px;
            color: #888;
        }
        
        .weights-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .section-title {
            color: #00d9ff;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .weights-visual {
            display: flex;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        .weight-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .weight-bar.qw { background: #91cc75; color: #000; }
        .weight-bar.om { background: #fac858; color: #000; }
        .weight-bar.yr { background: #00d9ff; color: #000; }
        
        .result-section {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            border: 2px solid #00d9ff;
            margin-bottom: 30px;
        }
        .result-title { color: #00d9ff; font-size: 20px; margin-bottom: 20px; }
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        .result-item {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
        }
        .result-value { font-size: 32px; font-weight: bold; color: #fff; }
        .result-label { font-size: 12px; color: #888; margin-top: 5px; }
        
        .refresh-btn {
            background: #00d9ff33;
            color: #00d9ff;
            border: 1px solid #00d9ff;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        .refresh-btn:hover { background: #00d9ff55; }
        
        .footer {
            text-align: center;
            color: #555;
            font-size: 12px;
            padding: 20px;
        }
    </style>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLQB2PE73Z"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JLQB2PE73Z');
    </script>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ä¸‰æºæ•°æ®å¯¹æ¯”ä¸èåˆè¿‡ç¨‹</h1>
        <p class="subtitle">å®æ—¶å±•ç¤ºå’Œé£ã€Open-Meteoã€yr.no ä¸‰æºæ•°æ®çš„å¼‚å¸¸æ£€æµ‹ã€æƒé‡è®¡ç®—ä¸èåˆç»“æœ</p>
        
        <div class="time-selector">
            <button onclick="prev()" id="btnPrev">â† ä¸Šä¸€ä¸ª</button>
            <select id="sel" onchange="load(this.value)">
                <option>åŠ è½½ä¸­...</option>
            </select>
            <button onclick="next()" id="btnNext">ä¸‹ä¸€ä¸ª â†’</button>
            <button class="refresh-btn" onclick="fetchData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        
        <div id="content">
            <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
        
        <div class="footer">
            <p>æ•°æ®å®æ—¶è¯»å–è‡ª huinan-merged.json | ç®—æ³•ç‰ˆæœ¬ï¼šV5.1</p>
            <p><a href="huinan-visualization-v5.html" style="color: #00d9ff;">â† è¿”å›ä¸»ç›‘æµ‹é¡µé¢</a></p>
        </div>
    </div>
    
    <script>
        let records = [];
        let idx = 0;
        const JSON_URL = 'https://monitor.kisara.info/huinan/huinan-merged.json';
        
        // åŠ è½½æ•°æ®
        async function fetchData() {
            document.getElementById('content').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>';
            
            try {
                const response = await fetch(JSON_URL + '?t=' + Date.now()); // é˜²æ­¢ç¼“å­˜
                const data = await response.json();
                
                // å¤„ç†æ•°æ®
                records = (data.records || []).map(r => ({
                    timestamp: r.timestamp || '',
                    temp: r.temp || 0,
                    humidity: r.humidity || 0,
                    dew: r.dew || 0,
                    pressure: r.pressure || 0,
                    windDir: r.windDir || 0,
                    windSpeed: r.windSpeed || 0,
                    qw: (r.raw_sources && r.raw_sources.qweather) || {},
                    om: (r.raw_sources && r.raw_sources.openmeteo) || {},
                    yr: (r.raw_sources && r.raw_sources.yrno) || {},
                    qw_check: (r.outlier_check && r.outlier_check.qweather) || {},
                    om_check: (r.outlier_check && r.outlier_check.openmeteo) || {},
                    yr_check: (r.outlier_check && r.outlier_check.yrno) || {},
                    weights: r.weights || {}
                }));
                
                if (records.length === 0) {
                    document.getElementById('content').innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                    return;
                }
                
                // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
                if (idx >= records.length) idx = records.length - 1;
                
                // æ›´æ–°é€‰æ‹©å™¨
                updateSelector();
                
                // æ¸²æŸ“
                render();
                
            } catch (err) {
                document.getElementById('content').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            }
        }
        
        function updateSelector() {
            const sel = document.getElementById('sel');
            sel.innerHTML = '';
            records.forEach((r, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = r.timestamp;
                if (i === idx) opt.selected = true;
                sel.appendChild(opt);
            });
        }
        
        function load(i) {
            idx = parseInt(i);
            render();
        }
        
        function prev() {
            if (idx > 0) {
                idx--;
                document.getElementById('sel').value = idx;
                render();
            }
        }
        
        function next() {
            if (idx < records.length - 1) {
                idx++;
                document.getElementById('sel').value = idx;
                render();
            }
        }
        
        function render() {
            if (records.length === 0) return;
            
            const r = records[idx];
            const qw = r.qw;
            const om = r.om;
            const yr = r.yr;
            const qwC = r.qw_check;
            const omC = r.om_check;
            const yrC = r.yr_check;
            const w = r.weights;
            
            const qwV = qwC.valid !== false;
            const omV = omC.valid !== false;
            const yrV = yrC.valid !== false;
            
            const qwW = w.qweather || 0.7;
            const omW = w.openmeteo || 0.3;
            const yrW = w.yrno || 0;
            
            let html = '<div class="sources-grid">';
            
            // å’Œé£
            html += '<div class="source-card qw">';
            html += '<div class="source-header"><div class="source-name qw">ğŸŒ¤ï¸ å’Œé£å¤©æ°”</div>';
            html += '<span class="source-status ' + (qwV ? 'ok' : 'err') + '">' + (qwV ? 'âœ“ æ­£å¸¸' : 'âœ— å¼‚å¸¸') + '</span></div>';
            html += '<div class="source-data">';
            html += '<div class="data-item"><div class="data-label">æ¸©åº¦</div><div class="data-value">' + (qw.temp || '--') + 'Â°C</div></div>';
            html += '<div class="data-item"><div class="data-label">æ¹¿åº¦</div><div class="data-value">' + (qw.humidity || '--') + '%</div></div>';
            html += '<div class="data-item"><div class="data-label">éœ²ç‚¹</div><div class="data-value">' + (qw.dew || '--') + 'Â°C</div></div>';
            html += '<div class="data-item"><div class="data-label">æ°”å‹</div><div class="data-value">' + (qw.pressure || '--') + 'hPa</div></div>';
            html += '<div class="data-item"><div class="data-label">é£å‘</div><div class="data-value">' + (qw.windDir || '--') + 'Â°</div></div>';
            html += '<div class="data-item"><div class="data-label">é£é€Ÿ</div><div class="data-value">' + (qw.windSpeed || '--') + 'm/s</div></div>';
            html += '</div>';
            if (qwC.note) html += '<div class="source-note">âš ï¸ ' + qwC.note + '</div>';
            html += '</div>';
            
            // OM
            html += '<div class="source-card om">';
            html += '<div class="source-header"><div class="source-name om">ğŸŒ Open-Meteo</div>';
            html += '<span class="source-status ' + (omV ? 'ok' : 'warn') + '">' + (omV ? 'âœ“ æ­£å¸¸' : 'âš ï¸ é™æƒ') + '</span></div>';
            html += '<div class="source-data">';
            html += '<div class="data-item"><div class="data-label">æ¸©åº¦</div><div class="data-value">' + (om.temp || '--') + 'Â°C</div></div>';
            html += '<div class="data-item"><div class="data-label">æ¹¿åº¦</div><div class="data-value">' + (om.humidity || '--') + '%</div></div>';
            html += '<div class="data-item"><div class="data-label">éœ²ç‚¹</div><div class="data-value">' + (om.dew || '--') + 'Â°C</div></div>';
            html += '<div class="data-item"><div class="data-label">æ°”å‹</div><div class="data-value">' + (om.pressure || '--') + 'hPa</div></div>';
            html += '<div class="data-item"><div class="data-label">é£å‘</div><div class="data-value">' + (om.windDir || '--') + 'Â°</div></div>';
            html += '<div class="data-item"><div class="data-label">é£é€Ÿ</div><div class="data-value">' + (om.windSpeed || '--') + 'm/s</div></div>';
            html += '</div>';
            if (omC.note) html += '<div class="source-note">âš ï¸ ' + omC.note + '</div>';
            html += '</div>';
            
            // yr.no
            html += '<div class="source-card yr">';
            html += '<div class="source-header"><div class="source-name yr">ğŸ‡³ğŸ‡´ yr.no</div>';
            html += '<span class="source-status ' + (yrV ? 'ok' : 'err') + '">' + (yrV ? 'âœ“ æ­£å¸¸' : 'âœ— å‰”é™¤') + '</span></div>';
            html += '<div class="source-data">';
            html += '<div class="data-item"><div class="data-label">æ¸©åº¦</div><div class="data-value">' + (yr.temp !== undefined ? yr.temp : '--') + 'Â°C</div></div>';
            html += '<div class="data-item"><div class="data-label">æ¹¿åº¦</div><div class="data-value">' + (yr.humidity !== undefined ? yr.humidity : '--') + '%</div></div>';
            html += '<div class="data-item"><div class="data-label">éœ²ç‚¹</div><div class="data-value">--</div></div>';
            html += '<div class="data-item"><div class="data-label">æ°”å‹</div><div class="data-value">' + (yr.pressure !== undefined ? yr.pressure : '--') + 'hPa</div></div>';
            html += '<div class="data-item"><div class="data-label">é£å‘</div><div class="data-value">' + (yr.windDir !== undefined ? yr.windDir : '--') + 'Â°</div></div>';
            html += '<div class="data-item"><div class="data-label">é£é€Ÿ</div><div class="data-value">' + (yr.windSpeed !== undefined ? yr.windSpeed : '--') + 'm/s</div></div>';
            html += '</div>';
            if (yrC.note) html += '<div class="source-note">âš ï¸ ' + yrC.note + '</div>';
            html += '<div class="source-note">ğŸ’¡ ä»…å‚ä¸æ°”å‹æ ¡éªŒ</div>';
            html += '</div>';
            
            html += '</div>';
            
            // æƒé‡
            html += '<div class="weights-section">';
            html += '<div class="section-title">âš–ï¸ æƒé‡è®¡ç®—ç»“æœ</div>';
            html += '<div class="weights-visual">';
            html += '<div class="weight-bar qw" style="width:' + (qwW * 100) + '%">' + Math.round(qwW * 100) + '%</div>';
            html += '<div class="weight-bar om" style="width:' + (omW * 100) + '%">' + Math.round(omW * 100) + '%</div>';
            if (yrW > 0) html += '<div class="weight-bar yr" style="width:' + (yrW * 100) + '%">' + Math.round(yrW * 100) + '%</div>';
            html += '</div></div>';
            
            // ç»“æœ
            html += '<div class="result-section">';
            html += '<div class="result-title">ğŸ¯ èåˆç»“æœ (' + (idx + 1) + ' / ' + records.length + ')</div>';
            html += '<div class="result-grid">';
            html += '<div class="result-item"><div class="result-value">' + r.temp + 'Â°C</div><div class="result-label">æ¸©åº¦</div></div>';
            html += '<div class="result-item"><div class="result-value">' + r.humidity + '%</div><div class="result-label">æ¹¿åº¦</div></div>';
            html += '<div class="result-item"><div class="result-value">' + r.dew + 'Â°C</div><div class="result-label">éœ²ç‚¹</div></div>';
            html += '<div class="result-item"><div class="result-value">' + r.pressure + 'hPa</div><div class="result-label">æ°”å‹</div></div>';
            html += '<div class="result-item"><div class="result-value">' + r.windDir + 'Â°</div><div class="result-label">é£å‘</div></div>';
            html += '<div class="result-item"><div class="result-value">' + r.windSpeed + 'm/s</div><div class="result-label">é£é€Ÿ</div></div>';
            html += '</div></div>';
            
            document.getElementById('content').innerHTML = html;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('btnPrev').disabled = idx === 0;
            document.getElementById('btnNext').disabled = idx === records.length - 1;
        }
        
        // å¯åŠ¨
        fetchData();
    </script>
</body>
</html>